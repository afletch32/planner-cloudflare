<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Schedule & Allowance Adventure</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#8b5e34" />
    <link rel="icon" href="/assets/icons/icon-32.png" sizes="32x32" />
    <link rel="apple-touch-icon" href="/assets/icons/icon-180.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Luckiest+Guy&family=Rubik:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @font-face {
        font-family: "CookieRun";
        src: url("/fonts/CookieRunFont_TTF/CookieRun Regular.ttf")
          format("truetype");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "CookieRun";
        src: url("/fonts/CookieRunFont_TTF/CookieRun Bold.ttf")
          format("truetype");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "CookieRun";
        src: url("/fonts/CookieRunFont_TTF/CookieRun Black.ttf")
          format("truetype");
        font-weight: 900;
        font-style: normal;
        font-display: swap;
      }
      :root {
        --credit-pink: #ff5ab7;
        --credit-blue: #3bd1ff;
        --credit-gold: #ffd54a;
        --credit-purple: #7b5dff;
        --credit-ink: #1e1b3a;
        --crk-cream: #fff4df;
        --crk-biscuit: #f6d5a9;
        --crk-caramel: #c9823b;
        --crk-choco: #5d3a1a;
        --crk-berry: #ff6aa0;
        --crk-mint: #5bd6c2;
        --crk-sky: #5cb7ff;
        --crk-gold: #f7c44a;
        --crk-ink: #2a1c14;
        --crk-panel: rgba(255, 250, 240, 0.92);
        --crk-shadow: rgba(64, 39, 20, 0.18);
      }
      .credit-hub {
        font-family: "Rubik", "Trebuchet MS", sans-serif;
        background: radial-gradient(
            circle at 15% 20%,
            rgba(255, 90, 183, 0.2),
            transparent 45%
          ),
          radial-gradient(
            circle at 85% 15%,
            rgba(59, 209, 255, 0.25),
            transparent 40%
          ),
          linear-gradient(135deg, #fffbf0 0%, #f7f2ff 50%, #eef8ff 100%);
        border-radius: 24px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(30, 27, 58, 0.12);
      }
      .credit-hub::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.6) 1px,
          transparent 1px
        );
        background-size: 18px 18px;
        opacity: 0.5;
        pointer-events: none;
      }
      .credit-title {
        font-family: "Luckiest Guy", "Trebuchet MS", cursive;
        letter-spacing: 0.06em;
        color: var(--credit-purple);
      }
      body {
        font-family: "CookieRun", "Fredoka", "Nunito", sans-serif;
        background: radial-gradient(
            circle at 12% 15%,
            rgba(255, 214, 169, 0.7),
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 8%,
            rgba(92, 183, 255, 0.25),
            transparent 35%
          ),
          linear-gradient(160deg, #fff3d6 0%, #fef9f2 55%, #f2f8ff 100%);
        color: var(--crk-ink);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: url("assets/crk/super-epic-cookie-lobby.webp") center/cover
          no-repeat;
        opacity: 0.16;
        pointer-events: none;
        z-index: -2;
      }
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(
            circle at 30% 30%,
            rgba(255, 255, 255, 0.7),
            transparent 60%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(255, 255, 255, 0.6),
            transparent 55%
          );
        z-index: -1;
        pointer-events: none;
      }
      .credit-pill {
        background: rgba(30, 27, 58, 0.08);
        border: 1px solid rgba(30, 27, 58, 0.08);
        border-radius: 999px;
        padding: 6px 14px;
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--credit-ink);
      }
      .credit-card {
        background: linear-gradient(135deg, #ffffff 0%, #fff6fd 100%);
        border-radius: 20px;
        padding: 18px;
        box-shadow: 0 12px 24px rgba(30, 27, 58, 0.1);
        border: 1px solid rgba(123, 93, 255, 0.15);
      }
      .credit-card.alt {
        background: linear-gradient(135deg, #ffffff 0%, #f1fbff 100%);
        border-color: rgba(59, 209, 255, 0.25);
      }
      .credit-stat {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed rgba(30, 27, 58, 0.12);
      }
      .credit-stat:last-child {
        border-bottom: none;
      }
      .credit-stat span:first-child {
        color: rgba(30, 27, 58, 0.7);
        font-size: 0.85rem;
      }
      .credit-stat span:last-child {
        font-weight: 800;
        font-size: 1.25rem;
        color: var(--credit-ink);
      }
      .cta-stack {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px;
      }
      .cta-button {
        border-radius: 18px;
        padding: 14px 18px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.85rem;
        box-shadow: 0 10px 20px rgba(30, 27, 58, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .cta-button:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 16px 24px rgba(30, 27, 58, 0.25);
      }
      .cta-primary {
        background: linear-gradient(135deg, #ff6ad5, #ffb86c);
        color: #1f0a2e;
      }
      .cta-secondary {
        background: linear-gradient(135deg, #4ce7ff, #7b5dff);
        color: white;
      }
      .cta-tertiary {
        background: linear-gradient(135deg, #ffe45c, #ff8f55);
        color: #2a1b1b;
      }
      .reward-shop-header {
        font-family: "Luckiest Guy", "Trebuchet MS", cursive;
        color: var(--credit-ink);
      }
      .crk-border {
        border: 4px solid #5d3a1a;
        border-radius: 24px;
      }
      @keyframes cookie-pop {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        70% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes sparkle-float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
          opacity: 0.8;
        }
        50% {
          transform: translateY(-20px) rotate(20deg);
          opacity: 1;
        }
      }
      .level-up-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }
      .level-up-card {
        background: linear-gradient(180deg, #fff9ea 0%, #ffd700 100%);
        border: 6px solid #8b4513;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        animation: cookie-pop 0.5s
          cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .sparkle {
        position: absolute;
        animation: sparkle-float 2s infinite ease-in-out;
        pointer-events: none;
      }
      .cookie-panel {
        background: var(--crk-panel);
        border: 4px solid var(--crk-choco);
        border-radius: 28px;
        box-shadow: 0 12px 0 rgba(210, 180, 140, 0.75),
          0 18px 30px var(--crk-shadow);
      }
      .cookie-title {
        font-family: "Fredoka", sans-serif;
        color: var(--crk-choco);
      }
      .cookie-label {
        color: #8b4513;
        font-weight: 700;
        letter-spacing: 0.12em;
      }
      .cookie-task {
        border: 3px solid var(--crk-choco);
        border-radius: 18px;
        background: linear-gradient(180deg, #ffffff 0%, #fff5e6 100%);
        box-shadow: 0 6px 0 rgba(210, 180, 140, 0.8),
          0 10px 18px rgba(93, 58, 26, 0.12);
      }
      .cookie-star {
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .cookie-star.active {
        transform: scale(1.08);
        background: #fef3c7;
        border-color: #f59e0b;
      }
      .cookie-avatar-stack {
        position: relative;
        display: inline-block;
        width: var(--avatar-size, 56px);
        height: var(--avatar-size, 56px);
      }
      .cookie-avatar-layer {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
      }
      .cookie-avatar-pill {
        background: #fff9ea;
        border: 2px solid #f3d4a8;
        border-radius: 999px;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .cookie-collection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 16px;
      }
      .cookie-card {
        background: rgba(255, 255, 255, 0.85);
        border: 2px solid rgba(93, 58, 26, 0.2);
        border-radius: 18px;
        padding: 12px;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 20px rgba(93, 58, 26, 0.12);
      }
      .cookie-card.locked::after {
        content: "LOCKED";
        position: absolute;
        inset: auto 0 0 0;
        padding: 6px 0;
        background: rgba(93, 58, 26, 0.85);
        color: #fff3d6;
        font-weight: 800;
        letter-spacing: 0.08em;
        font-size: 0.7rem;
      }
      .cookie-portrait {
        width: 100%;
        height: 140px;
        object-fit: contain;
        filter: drop-shadow(0 8px 10px rgba(93, 58, 26, 0.2));
      }
      .cookie-card.locked .cookie-portrait {
        filter: grayscale(1) brightness(0.75);
        opacity: 0.7;
      }
      .cookie-rarity {
        display: inline-block;
        margin-top: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 700;
        background: rgba(255, 214, 169, 0.8);
        color: #5d3a1a;
      }
      .cookie-action {
        margin-top: 8px;
        width: 100%;
        border-radius: 999px;
        border: none;
        padding: 6px 10px;
        font-weight: 800;
        font-size: 0.75rem;
        background: linear-gradient(135deg, #ffb55c 0%, #ff8f55 100%);
        color: #2a1b1b;
        cursor: pointer;
      }
      .cookie-action.secondary {
        background: linear-gradient(135deg, #66e6d1 0%, #5cb7ff 100%);
        color: #0c2c3a;
      }
      .cookie-collection-grid.selecting .cookie-card {
        pointer-events: none;
      }
      .cookie-select-pop {
        animation: cookie-select-pop 0.5s
          cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes cookie-select-pop {
        0% {
          transform: scale(0.9);
          box-shadow: 0 0 0 rgba(247, 196, 74, 0);
        }
        60% {
          transform: scale(1.06);
          box-shadow: 0 0 24px rgba(247, 196, 74, 0.6);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 10px 20px rgba(93, 58, 26, 0.12);
        }
      }
      .avatar-picker-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: 10px;
        justify-items: center;
      }
      .avatar-option {
        border: 2px solid transparent;
        border-radius: 14px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.7);
        transition: transform 0.2s ease, border-color 0.2s ease,
          box-shadow 0.2s ease;
      }
      .avatar-option:hover {
        transform: translateY(-2px);
        border-color: rgba(245, 158, 11, 0.6);
      }
      .avatar-option.active {
        border-color: #f59e0b;
        box-shadow: 0 8px 14px rgba(93, 58, 26, 0.18);
      }
      .avatar-option img {
        width: 56px;
        height: 56px;
        object-fit: contain;
      }
      .kingdom-shell {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 36px;
        box-shadow: 0 30px 60px rgba(74, 42, 15, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(4px);
      }
      .kingdom-hero {
        position: relative;
        overflow: hidden;
        background: linear-gradient(
            125deg,
            rgba(255, 247, 229, 0.95),
            rgba(255, 236, 208, 0.9)
          ),
          url("assets/crk/super-epic-cookie-lobby.webp") center/cover no-repeat;
      }
      .kingdom-hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          120deg,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(255, 255, 255, 0.4) 55%,
          transparent 100%
        );
        pointer-events: none;
      }
      .kingdom-logo {
        max-width: 220px;
        width: 100%;
        filter: drop-shadow(0 10px 14px rgba(93, 58, 26, 0.25));
      }
      .kingdom-mascot {
        width: 140px;
        height: auto;
        filter: drop-shadow(0 12px 18px rgba(93, 58, 26, 0.22));
        animation: floaty 3.6s ease-in-out infinite;
      }
      .kingdom-pill {
        background: rgba(255, 255, 255, 0.75);
        border: 2px solid rgba(201, 130, 59, 0.4);
        border-radius: 999px;
        padding: 6px 14px;
        font-weight: 700;
        color: var(--crk-choco);
      }
      .kingdom-button {
        background: linear-gradient(135deg, #ffb55c 0%, #ff8f55 100%);
        color: #2a1b1b;
        border-radius: 999px;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        box-shadow: 0 12px 20px rgba(138, 68, 11, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .kingdom-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 26px rgba(138, 68, 11, 0.28);
      }
      .kingdom-button.secondary {
        background: linear-gradient(135deg, #66e6d1 0%, #5cb7ff 100%);
        color: #0c2c3a;
      }
      .kingdom-tabbar {
        background: rgba(255, 255, 255, 0.7);
        border-radius: 18px;
        padding: 6px;
        border: 2px solid rgba(201, 130, 59, 0.25);
      }
      .tab-btn {
        border-radius: 14px;
        padding: 10px 14px;
        font-weight: 700;
        color: rgba(42, 28, 20, 0.7);
        transition: all 0.2s ease;
      }
      .tab-btn.active {
        background: linear-gradient(135deg, #fff1c5, #ffd987);
        color: #4b2a12;
        box-shadow: 0 6px 12px rgba(93, 58, 26, 0.18);
      }
      .kingdom-progress-track {
        background: rgba(255, 255, 255, 0.75);
        border: 2px solid rgba(201, 130, 59, 0.35);
        border-radius: 999px;
        height: 18px;
        box-shadow: inset 0 2px 6px rgba(93, 58, 26, 0.12);
      }
      .kingdom-progress-fill {
        background: linear-gradient(90deg, #6fe1ff, #ffd35c, #ff9e7a);
        height: 100%;
        border-radius: inherit;
        transition: width 0.5s ease;
        box-shadow: 0 8px 16px rgba(255, 158, 122, 0.35);
      }
      .fade-in {
        animation: soft-rise 0.7s ease both;
      }
      @keyframes floaty {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }
      @keyframes soft-rise {
        0% {
          opacity: 0;
          transform: translateY(12px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js");
        });
      }
      const HOUSEHOLD_ID = "fletcher-island";
      const HOUSEHOLD_NAME = "Fletcher Island";
      const PERSON_ID = "avery";
      const DEFAULT_GROUP_ID = "ashley-avery";
      const HOUSEHOLD_GROUPS = [
        { id: "ashley-avery", name: "Ashley and Avery" },
        { id: "sam-kids", name: "Sam and kids" },
        { id: "mimi-papa", name: "Mimi and Papa" },
      ];

      const FUNCTIONS_BASE_URL = localStorage.getItem("functionsBaseUrl") || "";
      const API_BASE = FUNCTIONS_BASE_URL
        ? FUNCTIONS_BASE_URL.replace(/\/$/, "")
        : "/api";
      const KINGDOM_API_URL =
        "https://planner-cloudflare-api.afletcherr32.workers.dev";

      const initialState = {
        player: {
          name: "New Cookie",
          level: 1,
          exp: 0,
          crystals: 100,
          jellies: 30,
          class: "Charge",
          avatar: "üç™",
          unlockedCookies: ["brave-default"],
          activeCookie: "brave-default",
          inventory: ["hat_01"],
          current_outfit: {
            body: "assets/cookie/slices/cookiebody/01.png",
            head: "assets/cookie/slices/hair/05.png",
            eyes: "assets/cookie/slices/eyesmouths/03.png",
            arms: "assets/cookie/slices/bodyposes/01.png",
            legs: "assets/cookie/slices/bodyposes/03.png",
            accessory: null,
          },
        },
        weekly_stars: {
          Schedule: [0, 0, 0, 0, 0],
        },
        inventory: [],
        quests: [
          {
            id: 1,
            title: "Clean the Jammery",
            reward: 50,
            energy: 5,
            type: "daily",
          },
          {
            id: 2,
            title: "Organize Sugar Quarry",
            reward: 100,
            energy: 10,
            type: "epic",
          },
        ],
      };

      let state = { ...initialState };
      let selectedDough = { class: "Charge", avatar: "üç™" };
      const cookieSubjects = ["Schedule"];
      const cookieDays = ["M", "T", "W", "T", "F"];
      const cookieStorageKey = "cookie-kingdom-state-v1";
      const cookieRewards = { starCrystals: 200, starExp: 100 };
      const ItemDatabase = [
        {
          id: "hat_01",
          type: "accessory",
          name: "Adventurer Hat",
          cost: 500,
          emoji: "ü§†",
        },
        {
          id: "eyes_01",
          type: "accessory",
          name: "Cool Shades",
          cost: 1000,
          emoji: "üòé",
        },
        {
          id: "skin_choco",
          type: "avatar",
          name: "Chocolate Dough",
          cost: 1500,
          emoji: "üç´",
        },
        {
          id: "skin_berry",
          type: "avatar",
          name: "Berry Dough",
          cost: 1500,
          emoji: "üçá",
        },
      ];
      const cookieCatalog = [
        {
          id: "brave-default",
          name: "Brave Cookie",
          image: "assets/cookies/brave/default.webp",
          cost: 0,
          rarity: "Common",
        },
        {
          id: "brave-happy",
          name: "Brave Cookie (Happy)",
          image: "assets/cookies/brave/happy.webp",
          cost: 150,
          rarity: "Common",
        },
        {
          id: "brave-hurray",
          name: "Brave Cookie (Hurray)",
          image: "assets/cookies/brave/hurray.webp",
          cost: 200,
          rarity: "Common",
        },
        {
          id: "brave-angry",
          name: "Brave Cookie (Angry)",
          image: "assets/cookies/brave/angry.webp",
          cost: 200,
          rarity: "Common",
        },
        {
          id: "white-lily-default",
          name: "White Lily Cookie",
          image: "assets/cookies/white-lily/default.png",
          cost: 600,
          rarity: "Epic",
        },
        {
          id: "white-lily-smile",
          name: "White Lily (Smile)",
          image: "assets/cookies/white-lily/smile.png",
          cost: 650,
          rarity: "Epic",
        },
        {
          id: "white-lily-happy",
          name: "White Lily (Happy)",
          image: "assets/cookies/white-lily/happy.png",
          cost: 650,
          rarity: "Epic",
        },
        {
          id: "white-lily-motivated",
          name: "White Lily (Motivated)",
          image: "assets/cookies/white-lily/motivated.png",
          cost: 700,
          rarity: "Epic",
        },
      ];

      async function apiFetch(path, options = {}) {
        const headers = {
          ...(options.headers || {}),
        };
        if (!options.body || options.body instanceof FormData) {
          // leave content-type alone for FormData
        } else if (!headers["Content-Type"]) {
          headers["Content-Type"] = "application/json";
        }
        const resp = await fetch(`${API_BASE}${path}`, {
          ...options,
          headers,
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || "Request failed");
        }
        return resp;
      }

      async function apiGetJson(path) {
        const resp = await apiFetch(path);
        return resp.json();
      }

      async function apiPostJson(path, body) {
        const resp = await apiFetch(path, {
          method: "POST",
          body: JSON.stringify(body),
        });
        return resp.json();
      }

      async function saveKingdom() {
        saveCookieLocalState();
        try {
          await fetch(KINGDOM_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(state),
          });
        } catch (error) {
          console.error("Kingdom Sync Failed!", error);
        }
      }

      function renderUI() {
        const nameEl = document.getElementById("cookie-name");
        if (nameEl) nameEl.textContent = state.player.name;
        const headerNameEl = document.getElementById("player-name");
        if (headerNameEl) headerNameEl.textContent = state.player.name;
        const levelEl = document.getElementById("cookie-level");
        if (levelEl) levelEl.textContent = state.player.level;
        const levelBadgeEl = document.getElementById("lvl-badge");
        if (levelBadgeEl) levelBadgeEl.textContent = `LVL ${state.player.level}`;
        const crystalEl = document.getElementById("cookie-crystals");
        if (crystalEl) crystalEl.textContent = state.player.crystals;
        const avatarEl = document.getElementById("cookie-avatar");
        if (avatarEl) renderCookieAvatar(avatarEl, 44);
        const mainAvatarEl = document.getElementById("main-avatar");
        if (mainAvatarEl) renderCookieAvatar(mainAvatarEl, 52);
        renderCookieStars();
      }

      function selectDough(className, avatar, event) {
        selectedDough = { class: className, avatar: avatar };
        document
          .querySelectorAll(".dough-btn")
          .forEach((btn) =>
            btn.classList.remove("border-amber-600", "bg-amber-100")
          );
        if (event?.currentTarget) {
          event.currentTarget.classList.add("border-amber-600", "bg-amber-100");
        }
      }

      async function checkFirstTime() {
        try {
          const response = await fetch(KINGDOM_API_URL);
          if (response.ok) {
            const data = await response.json();
            if (!data || !data.player || data.player.name === "New Cookie") {
              document.getElementById("setup-screen")?.classList.remove("hidden");
            } else {
              state = normalizeCookieState(data);
              renderUI();
            }
          }
        } catch (error) {
          const localState = loadCookieLocalState();
          if (localState) {
            state = normalizeCookieState(localState);
            renderUI();
            return;
          }
          console.log("Starting fresh Kingdom.");
        }
      }

      async function bakeCookie() {
        const name = document.getElementById("name-input").value.trim();
        if (!name) return alert("Your Cookie needs a name!");

        state.player.name = name;
        state.player.class = selectedDough.class;
        state.player.avatar = selectedDough.avatar;

        await saveKingdom();

        document.getElementById("setup-screen")?.classList.add("hidden");
        renderUI();
      }

      function getCookieById(cookieId) {
        return cookieCatalog.find((cookie) => cookie.id === cookieId);
      }

      function renderCookieAvatar(targetEl, size) {
        if (!targetEl) return;
        const cookie = getCookieById(state.player.activeCookie);
        targetEl.innerHTML = "";
        if (cookie) {
          const img = document.createElement("img");
          img.src = cookie.image;
          img.alt = cookie.name;
          img.style.width = `${size}px`;
          img.style.height = `${size}px`;
          img.style.objectFit = "contain";
          targetEl.appendChild(img);
          return;
        }
        targetEl.textContent = state.player.avatar || "üç™";
      }

      function openAvatarBuilder() {
        const modal = document.getElementById("avatar-builder-modal");
        renderCookieCollection();
        if (modal) modal.classList.remove("hidden");
      }

      function isCookieUnlocked(cookieId) {
        return (state.player.unlockedCookies || []).includes(cookieId);
      }

      function selectCookie(cookieId) {
        state.player.activeCookie = cookieId;
        saveKingdom();
        renderUI();
        renderCookieCollection(cookieId, "select");
      }

      function unlockCookie(cookieId) {
        const cookie = getCookieById(cookieId);
        if (!cookie || isCookieUnlocked(cookieId)) return;
        if (state.player.crystals < cookie.cost) {
          alert("Not enough crystals yet!");
          return;
        }
        state.player.crystals -= cookie.cost;
        state.player.unlockedCookies = [
          ...(state.player.unlockedCookies || []),
          cookieId,
        ];
        state.player.activeCookie = cookieId;
        saveKingdom();
        renderUI();
        renderCookieCollection(cookieId, "unlock");
      }

      function renderCookieCollection(focusId = null, mode = "select") {
        const preview = document.getElementById("avatar-preview");
        renderCookieAvatar(preview, 180);
        const grid = document.getElementById("cookie-collection-grid");
        if (!grid) return;
        grid.innerHTML = "";
        grid.classList.toggle("selecting", !!focusId);
        cookieCatalog.forEach((cookie) => {
          const unlocked = isCookieUnlocked(cookie.id);
          const card = document.createElement("div");
          card.className = `cookie-card${unlocked ? "" : " locked"}`;
          const img = document.createElement("img");
          img.className = "cookie-portrait";
          img.src = cookie.image;
          img.alt = cookie.name;
          const title = document.createElement("div");
          title.className = "mt-2 font-bold text-sm";
          title.textContent = cookie.name;
          const rarity = document.createElement("div");
          rarity.className = "cookie-rarity";
          rarity.textContent = cookie.rarity;
          const action = document.createElement("button");
          action.className = `cookie-action${unlocked ? " secondary" : ""}`;
          action.textContent = unlocked
            ? "Select"
            : `Unlock ‚Ä¢ ${cookie.cost} üíé`;
          action.addEventListener("click", () => {
            if (unlocked) {
              selectCookie(cookie.id);
            } else {
              unlockCookie(cookie.id);
            }
          });
          card.appendChild(img);
          card.appendChild(title);
          card.appendChild(rarity);
          card.appendChild(action);
          grid.appendChild(card);
          if (cookie.id === focusId) {
            card.classList.add("cookie-select-pop");
            if (mode === "unlock") {
              const label = document.createElement("div");
              label.textContent = "Unlocked!";
              label.className = "cookie-rarity";
              label.style.background = "rgba(92,183,255,0.2)";
              label.style.color = "#0c2c3a";
              card.appendChild(label);
            }
          }
        });
        if (focusId) {
          window.setTimeout(() => {
            grid.classList.remove("selecting");
          }, 500);
        }
      }

      function openShop() {
        document.getElementById("shop-modal")?.classList.remove("hidden");
        renderShopItems();
      }

      function renderShopItems() {
        const shopList = document.getElementById("shop-items-list");
        if (!shopList) return;
        const inventory = Array.isArray(state.player.inventory)
          ? state.player.inventory
          : [];
        shopList.innerHTML = ItemDatabase.map((item) => {
          const owned = inventory.includes(item.id);
          const canAfford = state.player.crystals >= item.cost;
          return `
            <div class="flex justify-between items-center p-3 border-2 rounded-xl ${
              owned
                ? "bg-green-100 border-green-500 opacity-70"
                : "bg-white border-amber-300"
            }">
              <div class="flex items-center gap-3">
                <span class="text-2xl">${item.emoji}</span>
                <div>
                  <div class="font-bold">${item.name}</div>
                  <div class="text-xs text-gray-500">${item.type}</div>
                </div>
              </div>
              ${
                owned
                  ? '<span class="text-green-600 font-bold">OWNED</span>'
                  : `<button onclick="purchaseItem('${item.id}')" ${
                      canAfford ? "" : "disabled"
                    }
                    class="bg-[#8b4513] text-white px-4 py-1 rounded-full text-sm font-bold disabled:bg-gray-400">
                    ${item.cost} üíé
                  </button>`
              }
            </div>
          `;
        }).join("");
      }

      async function purchaseItem(itemId) {
        const item = ItemDatabase.find((i) => i.id === itemId);
        if (!item) return;
        if (
          state.player.crystals >= item.cost &&
          !state.player.inventory.includes(itemId)
        ) {
          state.player.crystals -= item.cost;
          state.player.inventory.push(itemId);
          if (item.type === "avatar") {
            state.player.avatar = item.emoji;
            if (!state.player.current_outfit) {
              state.player.current_outfit = {
                avatar: item.emoji,
                accessory: null,
              };
            } else {
              state.player.current_outfit.avatar = item.emoji;
            }
          }
          alert(`üéâ You unlocked: ${item.name}!`);
          await saveKingdom();
          renderUI();
          renderShopItems();
        }
      }

      function normalizeCookieState(data) {
        const merged = {
          ...initialState,
          ...data,
          player: { ...initialState.player, ...(data?.player || {}) },
        };
        if (!merged.weekly_stars || !merged.weekly_stars.Schedule) {
          merged.weekly_stars = { Schedule: [0, 0, 0, 0, 0] };
        }
        if (!Array.isArray(merged.player.inventory)) {
          merged.player.inventory = ["hat_01"];
        }
        if (!Array.isArray(merged.player.unlockedCookies)) {
          merged.player.unlockedCookies = ["brave-default"];
        }
        if (!merged.player.activeCookie) {
          merged.player.activeCookie = merged.player.unlockedCookies[0];
        }
        if (
          merged.player.activeCookie &&
          !merged.player.unlockedCookies.includes(merged.player.activeCookie)
        ) {
          merged.player.activeCookie = merged.player.unlockedCookies[0];
        }
        if (!merged.player.current_outfit) {
          merged.player.current_outfit = {
            body: "assets/cookie/slices/cookiebody/01.png",
            head: "assets/cookie/slices/hair/05.png",
            eyes: "assets/cookie/slices/eyesmouths/03.png",
            arms: "assets/cookie/slices/bodyposes/01.png",
            legs: "assets/cookie/slices/bodyposes/03.png",
            accessory: null,
          };
        }
        merged.player.current_outfit.body =
          merged.player.current_outfit.body ||
          "assets/cookie/slices/cookiebody/01.png";
        merged.player.current_outfit.head =
          merged.player.current_outfit.head || "assets/cookie/slices/hair/05.png";
        merged.player.current_outfit.eyes =
          merged.player.current_outfit.eyes ||
          "assets/cookie/slices/eyesmouths/03.png";
        merged.player.current_outfit.arms =
          merged.player.current_outfit.arms ||
          "assets/cookie/slices/bodyposes/01.png";
        merged.player.current_outfit.legs =
          merged.player.current_outfit.legs ||
          "assets/cookie/slices/bodyposes/03.png";
        return merged;
      }

      function saveCookieLocalState() {
        try {
          localStorage.setItem(cookieStorageKey, JSON.stringify(state));
        } catch (error) {
          return;
        }
      }

      function loadCookieLocalState() {
        try {
          const raw = localStorage.getItem(cookieStorageKey);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return null;
          return parsed;
        } catch (error) {
          return null;
        }
      }

      function renderCookieStars() {
        const gridContainer = document.getElementById("cookie-subject-grids");
        if (!gridContainer) return;
        gridContainer.innerHTML = cookieSubjects
          .map(
            (subject) => `
              <div>
                <div class="flex justify-between text-[11px] font-bold mb-2 uppercase cookie-title">
                  <span>${subject}</span>
                  <span>${
                    state.weekly_stars[subject].filter((s) => s === 1).length
                  }/5</span>
                </div>
                <div class="flex justify-between gap-2">
                  ${state.weekly_stars[subject]
                    .map(
                      (val, idx) => `
                        <div onclick="toggleCookieStar('${subject}', ${idx})"
                          class="cookie-star w-10 h-10 rounded-xl flex items-center justify-center border-2 border-amber-200 ${
                            val
                              ? "active border-amber-500 bg-amber-100 shadow-inner"
                              : "bg-white text-amber-400"
                          }">
                          ${val ? "‚≠ê" : cookieDays[idx]}
                        </div>
                      `
                    )
                    .join("")}
                </div>
              </div>
            `
          )
          .join("");
      }

      function toggleCookieStar(subject, dayIdx) {
        if (!state.weekly_stars[subject]) return;
        if (state.weekly_stars[subject][dayIdx] === 1) return;
        state.weekly_stars[subject][dayIdx] = 1;
        state.player.crystals += cookieRewards.starCrystals;
        state.player.exp += cookieRewards.starExp;
        checkCookieLevelUp();
        saveKingdom();
        renderUI();
      }

      function checkCookieLevelUp() {
        const needed = state.player.level * 1000;
        if (state.player.exp >= needed) {
          state.player.level++;
          state.player.exp -= needed;
          triggerLevelUpAnimation();
        }
      }

      function updateCookieStarFromSchedule() {
        const today = new Date();
        const day = today.getDay();
        if (day < 1 || day > 5) return;
        const dayIdx = day - 1;
        const todayItems = getScheduleItemsForDate(getTodayString());
        if (!todayItems.length) return;
        const allDone = todayItems.every((item) => item.completed);
        if (allDone) {
          toggleCookieStar("Schedule", dayIdx);
        }
      }

      async function ensureHouseholdMeta() {
        return apiPostJson("/ensureHousehold", {
          householdId: HOUSEHOLD_ID,
          name: HOUSEHOLD_NAME,
          groups: HOUSEHOLD_GROUPS,
          people: [
            {
              personId: PERSON_ID,
              name: "Avery",
              role: "member",
              groupId: DEFAULT_GROUP_ID,
            },
          ],
        });
      }

      function loadPointsFromServer() {
        return apiGetJson(
          `/points?householdId=${encodeURIComponent(
            HOUSEHOLD_ID
          )}&personId=${encodeURIComponent(PERSON_ID)}`
        )
          .then((data) => {
            userPoints = parseInt(data.totalPoints, 10) || 0;
            updatePointsDisplay();
          })
          .catch(() => {
            // Ignore load errors to allow offline usage.
          });
      }

      function savePointsToServer() {
        return apiPostJson("/points", {
          householdId: HOUSEHOLD_ID,
          personId: PERSON_ID,
          totalPoints: userPoints,
        }).catch(() => {
          // Ignore save errors to allow offline usage.
        });
      }

      function saveCompletedTasks() {
        const completed = getScheduleItemsForDate(getTodayString()).map(
          (item) => ({
            id: item.id,
            task: item.task,
            time: item.time,
            endTime: item.endTime || "",
            type: item.type,
            completed: item.completed,
            actualActivity: item.actualActivity || "",
            pendingApproval: !!item.pendingApproval,
            pendingRelease: !!item.pendingRelease,
            proofImage: item.proofImage || "",
            autoReviewStatus: item.autoReviewStatus || "",
            groupId: item.groupId || DEFAULT_GROUP_ID,
          })
        );
        return apiPostJson("/completedTasks", {
          householdId: HOUSEHOLD_ID,
          personId: PERSON_ID,
          date: getTodayString(),
          tasks: completed,
        }).catch(() => {
          // Ignore save errors to allow offline usage.
        });
      }

      function saveDailyNotes() {
        return apiPostJson("/dailyNotes", {
          householdId: HOUSEHOLD_ID,
          personId: PERSON_ID,
          date: getTodayString(),
          notes: dailyNotes,
        }).catch(() => {
          // Ignore save errors to allow offline usage.
        });
      }

      function loadDailyNotes() {
        return apiGetJson(
          `/dailyNotes?householdId=${encodeURIComponent(
            HOUSEHOLD_ID
          )}&personId=${encodeURIComponent(
            PERSON_ID
          )}&date=${encodeURIComponent(getTodayString())}`
        )
          .then((data) => {
            dailyNotes = data.notes || "";
            dailyNotesEl.value = dailyNotes;
          })
          .catch(() => {
            // Ignore load errors to allow offline usage.
          });
      }

      function moodStorageKey(dateString) {
        return `mood:${HOUSEHOLD_ID}:${PERSON_ID}:${dateString}`;
      }

      function journalStorageKey(dateString) {
        return `journal:${HOUSEHOLD_ID}:${PERSON_ID}:${dateString}`;
      }

      function updateMoodButtons() {
        moodButtons.forEach((button) => {
          const mood = button.getAttribute("data-mood");
          if (mood === selectedMood) {
            button.classList.add("bg-blue-600", "text-white");
            button.classList.remove("bg-blue-50", "text-blue-700");
          } else {
            button.classList.remove("bg-blue-600", "text-white");
            button.classList.add("bg-blue-50", "text-blue-700");
          }
        });
      }

      function loadMoodCheckin() {
        const key = moodStorageKey(getTodayString());
        const saved = localStorage.getItem(key);
        if (!saved) {
          moodStatusEl.textContent = "";
          return;
        }
        try {
          const parsed = JSON.parse(saved);
          selectedMood = parsed.mood || null;
          if (parsed.note && moodNoteEl) {
            moodNoteEl.value = parsed.note;
          }
          if (parsed.savedAt && moodStatusEl) {
            const savedAt = new Date(parsed.savedAt);
            moodStatusEl.textContent = `Saved at ${savedAt.toLocaleTimeString()}`;
          }
          updateMoodButtons();
        } catch (error) {
          console.warn("Failed to parse mood check-in", error);
        }
      }

      function saveMoodCheckin() {
        if (!selectedMood) {
          showCelebration("Pick a mood first.");
          return;
        }
        const payload = {
          mood: selectedMood,
          note: moodNoteEl ? moodNoteEl.value : "",
          savedAt: new Date().toISOString(),
        };
        localStorage.setItem(
          moodStorageKey(getTodayString()),
          JSON.stringify(payload)
        );
        moodStatusEl.textContent = `Saved at ${new Date(
          payload.savedAt
        ).toLocaleTimeString()}`;
        showCelebration("Mood saved!");
        renderDailyBonusMissions();
        renderWeeklyChores();
        renderMonthlyChores();
      }

      function loadJournal() {
        const key = journalStorageKey(getTodayString());
        const saved = localStorage.getItem(key);
        if (saved && journalEntryEl) {
          journalEntryEl.value = saved;
        }
      }

      function saveJournal() {
        if (!journalEntryEl) return;
        const key = journalStorageKey(getTodayString());
        localStorage.setItem(key, journalEntryEl.value || "");
        showCelebration("Journal saved!");
        renderDailyBonusMissions();
        renderWeeklyChores();
        renderMonthlyChores();
      }

      function loadMissionsFromStorage() {
        const saved = localStorage.getItem(missionsStorageKey);
        if (!saved) return;
        try {
          const parsed = JSON.parse(saved);
          weeklyChores = Array.isArray(parsed.weeklyMissions)
            ? parsed.weeklyMissions
            : weeklyChores;
          monthlyChores = Array.isArray(parsed.monthlyMissions)
            ? parsed.monthlyMissions
            : monthlyChores;
          dailyBonusMissions = Array.isArray(parsed.dailyBonusMissions)
            ? parsed.dailyBonusMissions
            : dailyBonusMissions;
        } catch (error) {
          console.warn("Failed to parse missions storage", error);
        }
      }

      function saveMissionsToStorage() {
        const payload = {
          weeklyMissions: weeklyChores,
          monthlyMissions: monthlyChores,
          dailyBonusMissions: dailyBonusMissions,
        };
        localStorage.setItem(missionsStorageKey, JSON.stringify(payload));
      }

      function loadTodayTasks() {
        return apiGetJson(
          `/completedTasks?householdId=${encodeURIComponent(
            HOUSEHOLD_ID
          )}&personId=${encodeURIComponent(
            PERSON_ID
          )}&date=${encodeURIComponent(getTodayString())}`
        )
          .then((data) => {
            const tasks = Array.isArray(data.tasks) ? data.tasks : [];
            tasks.forEach((saved) => {
              let target = scheduleItems.find((item) => item.id === saved.id);
              if (!target) {
                target = scheduleItems.find(
                  (item) => item.time === saved.time && item.task === saved.task
                );
              }
              if (target) {
                target.completed = !!saved.completed;
                target.actualActivity = saved.actualActivity || "";
                target.pendingApproval = !!saved.pendingApproval;
                target.pendingRelease = !!saved.pendingRelease;
                target.proofImage = saved.proofImage || "";
                target.autoReviewStatus = saved.autoReviewStatus || "";
              }
            });
            if (settings.pointsEnabled) {
              pendingPoints = getScheduleItemsForDate(getTodayString()).reduce(
                (total, item) => {
                  if (item.pendingApproval || item.pendingRelease) {
                    return total + getEffectivePoints(item);
                  }
                  return total;
                },
                0
              );
              updatePointsDisplay();
            }
          })
          .catch(() => {
            // Ignore load errors to allow offline usage.
          });
      }

      function formatTaskType(type) {
        const labels = {
          focus: "Focus Block",
          break: "Break",
          chore: "Mission",
          personal: "Personal",
        };
        return labels[type] || type;
      }

      async function loadDefaultTasks() {
        try {
          const resp = await fetch("/data/default-tasks.json", {
            headers: { "cache-control": "no-cache" },
          });
          if (!resp.ok) {
            throw new Error("Failed to load default tasks");
          }
          const data = await resp.json();
          scheduleItems = Array.isArray(data.scheduleItems)
            ? data.scheduleItems
            : [];
        } catch (error) {
          console.warn("Unable to load default tasks", error);
        }
      }

      async function loadDefaultMissions() {
        try {
          const resp = await fetch("/data/default-missions.json", {
            headers: { "cache-control": "no-cache" },
          });
          if (!resp.ok) {
            throw new Error("Failed to load default missions");
          }
          const data = await resp.json();
          const now = new Date();
          const currentMonth = getMonthName(now);
          const currentWeek = `Week ${getWeekOfMonth(now)}`;
          const currentDay = now.toLocaleDateString("en-US", {
            weekday: "long",
          });

          weeklyChores = Array.isArray(data.weeklyMissions)
            ? data.weeklyMissions.map((mission) => ({
                ...mission,
                weekOfMonth:
                  mission.weekOfMonth === "CURRENT_WEEK"
                    ? currentWeek
                    : mission.weekOfMonth,
              }))
            : [];
          monthlyChores = Array.isArray(data.monthlyMissions)
            ? data.monthlyMissions.map((mission) => ({
                ...mission,
                month:
                  mission.month === "CURRENT_MONTH"
                    ? currentMonth
                    : mission.month,
              }))
            : [];
          dailyBonusMissions = Array.isArray(data.dailyBonusMissions)
            ? data.dailyBonusMissions.map((mission) => ({
                ...mission,
                dayOfWeek:
                  mission.dayOfWeek === "CURRENT_DAY"
                    ? currentDay
                    : mission.dayOfWeek,
              }))
            : [];
        } catch (error) {
          console.warn("Unable to load default missions", error);
        }
      }

      function loadHistoryData(date) {
        const dataBox = document.getElementById("history-content");
        dataBox.innerHTML = '<p class="text-gray-500">Loading...</p>';

        Promise.all([
          apiGetJson(
            `/dailyNotes?householdId=${encodeURIComponent(
              HOUSEHOLD_ID
            )}&personId=${encodeURIComponent(
              PERSON_ID
            )}&date=${encodeURIComponent(date)}`
          ),
          apiGetJson(
            `/completedTasks?householdId=${encodeURIComponent(
              HOUSEHOLD_ID
            )}&personId=${encodeURIComponent(
              PERSON_ID
            )}&date=${encodeURIComponent(date)}`
          ),
        ])
          .then(([notesData, tasksData]) => {
            const notes = notesData?.notes || "";
            const tasks = Array.isArray(tasksData?.tasks)
              ? tasksData.tasks
              : [];
            let html = "";

            if (tasks.length > 0) {
              html +=
                '<div><h3 class="font-semibold text-gray-800 mb-1">Daily Timeline:</h3><ul class="list-disc list-inside text-gray-700">';
              tasks.forEach((t) => {
                const status = t.completed ? "‚úÖ" : "‚è≥";
                const actual = t.actualActivity
                  ? ` ‚Äî Actual: ${t.actualActivity}`
                  : "";
                html += `<li>${status} <strong>${
                  t.time || "Anytime"
                }</strong> ‚Äì ${t.task} (${formatTaskType(
                  t.type
                )})${actual}</li>`;
              });
              html += "</ul></div>";
            } else {
              html +=
                '<p class="text-gray-500">No completed tasks for this day.</p>';
            }

            if (notes) {
              html +=
                '<div class="mt-4"><h3 class="font-semibold text-gray-800 mb-1">Notes:</h3>';
              html += `<p class="text-gray-700 whitespace-pre-line">${notes}</p></div>`;
            }

            dataBox.innerHTML = html;
          })
          .catch(() => {
            dataBox.innerHTML =
              '<p class="text-red-500">Failed to load history data.</p>';
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const historyInput = document.getElementById("history-date");
        if (historyInput) {
          historyInput.addEventListener("change", () => {
            const selectedDate = historyInput.value;
            if (selectedDate) loadHistoryData(selectedDate);
          });
        }
      });
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Nunito", sans-serif;
        background-color: #f0f9ff;
      }
      .task-card {
        transition: all 0.3s ease;
      }
      .task-card:hover {
        transform: translateY(-3px);
      }
      .task-card.collapsed .task-details {
        display: none;
      }
      .completed {
        opacity: 0.6;
        text-decoration: line-through;
      }
      .current-task {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
      }
      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #f00;
        opacity: 0;
      }
      .focus-block {
        border-left: 4px solid #3b82f6;
      }
      .break-block {
        border-left: 4px solid #10b981;
      }
      .chore-block {
        border-left: 4px solid #f59e0b;
      }
      .personal-block {
        border-left: 4px solid #8b5cf6;
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: #68d391;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #68d391;
      }
    </style>
  </head>
  <body>
    <div class="container mx-auto px-4 py-8 max-w-5xl kingdom-shell">
      <!-- Header -->
      <div class="cookie-panel kingdom-hero p-6 flex flex-col lg:flex-row justify-between items-center gap-6 mb-8 fade-in">
        <div class="relative z-10">
          <img
            src="assets/crk/cookie-run-kingdom-logo.png"
            alt="Cookie Run Kingdom"
            class="kingdom-logo mb-3"
          />
          <div class="flex flex-wrap items-center gap-2">
            <h1 class="text-3xl md:text-4xl font-bold cookie-title">
              My Daily Adventure
            </h1>
            <span class="kingdom-pill">‚ú® Allowance Quest</span>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <div
              id="main-avatar"
              class="cursor-pointer"
              onclick="openAvatarBuilder()"
            ></div>
            <div>
              <div id="player-name" class="text-xl font-bold text-amber-800">
                New Cookie
              </div>
              <div
                id="lvl-badge"
                class="bg-amber-600 text-white text-[10px] px-2 py-0.5 rounded-full inline-block"
              >
                LVL 1
              </div>
            </div>
          </div>
          <p class="text-amber-700" id="current-date">Loading date...</p>
        </div>
        <div class="relative z-10 flex flex-col items-end gap-2">
          <div class="flex items-center gap-3 text-sm">
            <button
              onclick="openShop()"
              class="kingdom-button px-4 py-2 text-xs"
            >
              Shop
            </button>
            <button
              class="kingdom-button secondary px-4 py-2 text-xs"
              onclick="openAvatarBuilder()"
            >
              Collection
            </button>
          </div>
          <button
            id="admin-toggle"
            class="text-sm text-amber-900 hover:text-amber-950 underline"
          >
            Admin Sign In
          </button>
          <div class="bg-[#fff9ea] border-2 border-amber-200 p-4 rounded-2xl shadow-md">
            <p class="text-xl font-bold text-center cookie-title" id="current-time">
              Loading time...
            </p>
            <p class="text-sm text-amber-700 text-center">Current Time</p>
          </div>
        </div>
        <img
          src="assets/crk/brave-hurray.webp"
          alt="Brave Cookie"
          class="kingdom-mascot hidden lg:block"
        />
      </div>

      <!-- Progress Bar -->
      <div class="mb-8 fade-in">
        <div class="flex justify-between mb-2">
          <span class="text-sm font-medium text-amber-800"
            >Adventure Progress</span
          >
          <span class="text-sm font-medium text-amber-800" id="progress-text"
            >0%</span
          >
        </div>
        <div class="kingdom-progress-track w-full">
          <div
            class="kingdom-progress-fill"
            id="progress-bar"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mb-6 fade-in">
        <div class="kingdom-tabbar flex flex-wrap gap-2">
          <button class="tab-btn active" data-tab="schedule">
            Daily Adventure
          </button>
          <button class="tab-btn" data-tab="missions">Missions</button>
          <button class="tab-btn" data-tab="journal">Journal</button>
          <button class="tab-btn" data-tab="habits">Habits & Tasks</button>
          <button class="tab-btn" data-tab="rewards">
            Allowance & Rewards
          </button>
        </div>
      </div>

      <!-- Schedule Tab Content -->
      <div id="schedule-tab" class="tab-content">
        <div class="text-center mb-10 fade-in">
          <span
            class="text-amber-700 font-semibold text-sm uppercase tracking-wide"
            >Today's Work</span
          >
          <h2 class="text-2xl md:text-3xl font-bold cookie-title mt-2 mb-3">
            Live Schedule &amp; Unfinished Tasks
          </h2>
          <p class="text-amber-800 max-w-2xl mx-auto">
            The schedule updates automatically based on the current time.
            Unfinished tasks collect anything earlier today that isn't marked
            complete, plus anytime tasks.
          </p>
          <div class="flex flex-wrap items-center justify-center gap-2 mt-5">
            <button
              id="refactor-schedule"
              class="kingdom-pill text-sm"
            >
              Refactor Schedule
            </button>
            <button
              id="edit-schedule"
              class="admin-only kingdom-pill text-sm"
            >
              Edit Adventure
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <div class="cookie-panel p-5">
              <h3 class="text-lg font-semibold cookie-title mb-3">
                Schedule (Today)
              </h3>
              <div id="schedule-container" class="space-y-3"></div>
              <div id="anytime-section" class="mt-6 hidden">
                <h4 class="text-lg font-semibold cookie-title mb-2">
                  Anytime Tasks
                </h4>
                <div id="anytime-container" class="space-y-3"></div>
              </div>
            </div>

            <!-- Notes Section -->
            <div class="cookie-panel p-4 mt-6">
              <h3 class="text-lg font-semibold cookie-title mb-2">
                Today's Notes
              </h3>
              <textarea
                id="daily-notes"
                class="w-full h-24 p-2 border border-amber-200 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-400 bg-white/80"
                placeholder="Write your notes here..."
              ></textarea>
              <div class="mt-2 text-right">
                <button
                  id="save-notes"
                  class="kingdom-button px-4 py-2 text-xs"
                >
                  Save Notes
                </button>
              </div>
            </div>
          </div>
          <div class="lg:col-span-1">
            <div class="cookie-panel p-5">
              <h3 class="text-lg font-semibold cookie-title mb-3">
                Unfinished Tasks
              </h3>
              <div id="unfinished-container" class="space-y-2"></div>
            </div>
          </div>
        </div>

        <section class="cookie-panel p-6 mt-8">
          <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <div>
              <div class="text-xs uppercase cookie-label">Cookie Kingdom</div>
              <h3 class="text-2xl font-bold cookie-title">
                Weekly Exploration
              </h3>
            </div>
            <div class="text-right text-sm cookie-title">
              <div class="flex items-center justify-end gap-2">
                <span id="cookie-avatar"></span>
                <span id="cookie-name">New Cookie</span>
              </div>
              <div>LVL <span id="cookie-level">1</span></div>
              <div>üíé <span id="cookie-crystals">0</span></div>
              <button
                id="open-avatar-builder"
                class="mt-2 kingdom-button px-4 py-2 text-[10px]"
              >
                Collection
              </button>
            </div>
          </div>
          <div id="cookie-subject-grids" class="space-y-4"></div>
        </section>
      </div>

      <!-- Missions Tab Content -->
      <div id="missions-tab" class="tab-content hidden">
        <div class="space-y-8">
          <section>
            <div class="flex justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-800">Weekly Missions</h2>
              <button
                id="add-weekly-chore"
                class="admin-only bg-green-100 text-green-600 px-3 py-1 rounded-md hover:bg-green-200 transition"
              >
                Add Mission
              </button>
            </div>
            <div class="grid grid-cols-1 gap-4" id="weekly-container">
              <!-- Weeks will be populated here -->
            </div>
          </section>

          <section>
            <div class="flex justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-800">
                Daily Bonus Missions
              </h2>
              <button
                id="add-daily-bonus"
                class="admin-only bg-amber-100 text-amber-700 px-3 py-1 rounded-md hover:bg-amber-200 transition"
              >
                Add Bonus Mission
              </button>
            </div>
            <div class="grid grid-cols-1 gap-4" id="daily-bonus-container">
              <!-- Days of the week will be populated here -->
            </div>
          </section>

          <section>
            <div class="flex justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-800">Monthly Missions</h2>
              <button
                id="add-monthly-chore"
                class="admin-only bg-purple-100 text-purple-600 px-3 py-1 rounded-md hover:bg-purple-200 transition"
              >
                Add Mission
              </button>
            </div>
            <div class="grid grid-cols-1 gap-4" id="monthly-container">
              <!-- Weeks will be populated here -->
            </div>
          </section>
        </div>
      </div>

      <!-- Journal Tab Content -->
      <div id="journal-tab" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">
              Mood Check-in
            </h3>
            <div class="flex flex-wrap gap-2" id="mood-buttons">
              <button class="mood-btn bg-blue-50 text-blue-700 px-3 py-1 rounded-md border border-blue-200" data-mood="great">Great</button>
              <button class="mood-btn bg-blue-50 text-blue-700 px-3 py-1 rounded-md border border-blue-200" data-mood="good">Good</button>
              <button class="mood-btn bg-blue-50 text-blue-700 px-3 py-1 rounded-md border border-blue-200" data-mood="ok">Okay</button>
              <button class="mood-btn bg-blue-50 text-blue-700 px-3 py-1 rounded-md border border-blue-200" data-mood="meh">Meh</button>
              <button class="mood-btn bg-blue-50 text-blue-700 px-3 py-1 rounded-md border border-blue-200" data-mood="hard">Hard</button>
            </div>
            <textarea
              id="mood-note"
              class="w-full h-20 mt-3 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Optional note..."
            ></textarea>
            <div class="mt-2 flex items-center justify-between">
              <p id="mood-status" class="text-sm text-gray-500"></p>
              <button
                id="save-mood"
                class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition"
              >
                Save Mood
              </button>
            </div>
          </div>

          <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">
              Daily Journal
            </h3>
            <textarea
              id="journal-entry"
              class="w-full h-48 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Write about your day..."
            ></textarea>
            <div class="mt-2 text-right">
              <button
                id="save-journal"
                class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition"
              >
                Save Journal
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Habits Tab Content -->
      <div id="habits-tab" class="tab-content hidden">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <div>
            <h2 class="text-xl font-bold text-gray-800">Habit Tracker</h2>
            <p class="text-sm text-gray-500">
              Track micro tasks by category and add new ones as needed.
            </p>
          </div>
          <button
            id="habit-save"
            class="kingdom-button px-4 py-2 text-xs"
          >
            Save Habits
          </button>
        </div>
        <div class="mb-4 flex flex-wrap gap-2">
          <input
            id="habit-category-input"
            type="text"
            class="flex-1 min-w-[180px] border border-gray-300 rounded-md px-3 py-2 text-sm"
            placeholder="Category (e.g., Personal)"
          />
          <input
            id="habit-item-input"
            type="text"
            class="flex-1 min-w-[180px] border border-gray-300 rounded-md px-3 py-2 text-sm"
            placeholder="New habit (e.g., Brush teeth)"
          />
          <button
            id="habit-item-add"
            class="bg-blue-100 text-blue-600 px-3 py-2 rounded-md hover:bg-blue-200 transition"
          >
            Add Habit
          </button>
        </div>
        <div id="habits-container" class="space-y-4"></div>
      </div>

      <!-- Rewards Tab Content -->
      <div id="rewards-tab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">Allowance & Rewards</h2>
          <button
            id="point-settings"
            class="bg-blue-100 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-200 transition"
          >
            Allowance Settings
          </button>
        </div>

        <section class="credit-hub mb-6">
          <div class="relative z-10">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
              <div>
                <p class="credit-title text-sm uppercase">Credits HQ</p>
                <h3 class="text-2xl md:text-3xl font-extrabold text-[#1e1b3a]">
                  Power up your rewards
                </h3>
                <p class="text-sm text-[#433d6e] mt-2">
                  Stack streaks, boost missions, and cash in your victories.
                </p>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="credit-pill">Daily Bonus Ready</span>
                <span class="credit-pill">Streak: 4 Days</span>
                <span class="credit-pill">Next Drop: 6 PM</span>
              </div>
            </div>

            <div
              id="points-display-container"
              class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6"
            >
              <div id="points-card" class="credit-card">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-extrabold text-[#1e1b3a]">
                    Stars Balance
                  </h4>
                  <span class="credit-pill">Points</span>
                </div>
                <div class="space-y-1">
                  <div class="credit-stat">
                    <span>Total earnings</span>
                    <span><span id="points-total-earnings">0</span> ‚≠ê</span>
                  </div>
                  <div class="credit-stat">
                    <span>Pending earnings</span>
                    <span><span id="pending-points-display">0</span> ‚≠ê</span>
                  </div>
                  <div class="credit-stat">
                    <span>Current balance</span>
                    <span><span id="points-display">0</span> ‚≠ê</span>
                  </div>
                </div>
                <div class="mt-4">
                  <div class="w-full bg-white rounded-full h-4 mb-2">
                    <div
                      class="bg-purple-600 h-4 rounded-full transition-all duration-500"
                      id="points-progress"
                      style="width: 0%"
                    ></div>
                  </div>
                  <p class="text-xs text-purple-700">
                    Collect stars to unlock colorful rewards.
                  </p>
                </div>
              </div>
              <div class="credit-card alt">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-extrabold text-[#1e1b3a]">
                    Cash Balance
                  </h4>
                  <span class="credit-pill">Money</span>
                </div>
                <div class="space-y-1">
                  <div class="credit-stat">
                    <span>Total earnings</span>
                    <span>$<span id="money-total-earnings">0.00</span></span>
                  </div>
                  <div class="credit-stat">
                    <span>Pending earnings</span>
                    <span>$<span id="money-pending-earnings">0.00</span></span>
                  </div>
                  <div class="credit-stat">
                    <span>Current balance</span>
                    <span>$<span id="money-current-balance">0.00</span></span>
                  </div>
                </div>
                <div class="mt-4">
                  <div class="w-full bg-white rounded-full h-4 mb-2">
                    <div
                      class="bg-[#3bd1ff] h-4 rounded-full transition-all duration-500"
                      style="width: 45%"
                    ></div>
                  </div>
                  <p class="text-xs text-[#2d6f85]">
                    Money rewards release after approval.
                  </p>
                </div>
              </div>
            </div>

            <div class="cta-stack mb-6">
              <button class="cta-button cta-primary">
                Restore your streak!
              </button>
              <button class="cta-button cta-secondary">
                Double mission rewards
              </button>
              <button class="cta-button cta-tertiary">
                Unlock bonus pack
              </button>
            </div>
          </div>
        </section>

        <div class="flex justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800 reward-shop-header">
            Reward Shop
          </h3>
          <button
            id="add-reward"
            class="bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 text-white px-4 py-2 rounded-xl font-semibold shadow-lg hover:shadow-xl transition"
          >
            Add Reward
          </button>
        </div>
        <div
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
          id="rewards-container"
        ></div>
      </div>

      <!-- Edit Schedule Modal -->
      <div
        id="edit-modal"
        class="admin-only fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-lg p-6 w-full max-w-md max-h-[80vh] overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Edit Adventure</h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div id="edit-schedule-container" class="space-y-4"></div>
          <div class="mt-6 flex justify-between">
            <button
              id="add-schedule-item"
              class="bg-blue-100 text-blue-600 px-4 py-2 rounded-md hover:bg-blue-200 transition"
            >
              Add Item
            </button>
            <button
              id="save-schedule"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>

      <!-- Add Mission Modal -->
      <div
        id="chore-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800" id="chore-modal-title">
              Add New Mission
            </h3>
            <button
              id="close-chore-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-1">Mission Name</label>
              <input
                type="text"
                id="chore-name"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div id="chore-points-container">
              <label class="block text-gray-700 mb-1">Stars</label>
              <input
                type="number"
                id="chore-points"
                min="1"
                value="5"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div id="mission-requirements" class="space-y-3">
              <div>
                <label class="block text-gray-700 mb-1">Requirement 1</label>
                <div class="grid grid-cols-2 gap-2">
                  <select
                    id="mission-req-1-type"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="mood">Mood check-ins</option>
                    <option value="journal">Journal entries</option>
                  </select>
                  <input
                    type="number"
                    id="mission-req-1-target"
                    min="1"
                    value="5"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
              <div>
                <label class="block text-gray-700 mb-1">Requirement 2 (optional)</label>
                <div class="grid grid-cols-2 gap-2">
                  <select
                    id="mission-req-2-type"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">None</option>
                    <option value="mood">Mood check-ins</option>
                    <option value="journal">Journal entries</option>
                  </select>
                  <input
                    type="number"
                    id="mission-req-2-target"
                    min="1"
                    value="5"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
            </div>
            <div id="chore-day-container" class="hidden">
              <label class="block text-gray-700 mb-1">Day</label>
              <select
                id="chore-day"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
              </select>
            </div>
            <div id="chore-week-container" class="hidden">
              <label class="block text-gray-700 mb-1">Week</label>
              <select
                id="chore-week"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="Week 1">Week 1</option>
                <option value="Week 2">Week 2</option>
                <option value="Week 3">Week 3</option>
                <option value="Week 4">Week 4</option>
                <option value="Week 5">Week 5</option>
              </select>
            </div>
            <div id="chore-month-container" class="hidden">
              <label class="block text-gray-700 mb-1">Month</label>
              <select
                id="chore-month"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
            </div>
          </div>
          <div class="mt-6">
            <button
              id="save-chore"
              class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"
            >
              Add Mission
            </button>
          </div>
        </div>
      </div>

      <!-- Add Reward Modal -->
      <div
        id="reward-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Add New Reward</h3>
            <button
              id="close-reward-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-1">Reward Name</label>
              <input
                type="text"
                id="reward-name"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Stars Required</label>
              <input
                type="number"
                id="reward-points"
                min="1"
                value="20"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Icon (emoji)</label>
              <input
                type="text"
                id="reward-icon"
                value="üéÅ"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
          <div class="mt-6">
            <button
              id="save-reward"
              class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition"
            >
              Add Reward
            </button>
          </div>
        </div>
      </div>

      <!-- Point Settings Modal -->
      <div
        id="points-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Allowance Settings</h3>
            <button
              id="close-points-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="space-y-6">
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-700 font-medium"
                  >Enable Allowance Stars</span
                >
                <div
                  class="relative inline-block w-12 align-middle select-none"
                >
                  <input
                    type="checkbox"
                    id="points-toggle"
                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                    checked
                  />
                  <label
                    for="points-toggle"
                    class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"
                  ></label>
                </div>
              </div>
              <p class="text-sm text-gray-500">
                Turn off to hide stars and rewards but still track mission
                completion.
              </p>
            </div>

            <div id="point-values-container">
              <h4 class="font-semibold text-gray-700 mb-2">
                Default Star Values
              </h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <label class="text-gray-600">Daily Adventure Tasks</label>
                  <input
                    type="number"
                    id="daily-task-points"
                    min="0"
                    value="5"
                    class="w-20 border border-gray-300 rounded-md px-2 py-1 text-center"
                  />
                </div>
                <div class="flex items-center justify-between">
                  <label class="text-gray-600">Weekly Missions</label>
                  <input
                    type="number"
                    id="weekly-chore-points"
                    min="0"
                    value="10"
                    class="w-20 border border-gray-300 rounded-md px-2 py-1 text-center"
                  />
                </div>
                <div class="flex items-center justify-between">
                  <label class="text-gray-600">Monthly Missions</label>
                  <input
                    type="number"
                    id="monthly-chore-points"
                    min="0"
                    value="20"
                    class="w-20 border border-gray-300 rounded-md px-2 py-1 text-center"
                  />
                </div>
              </div>
            </div>

            <div>
              <button
                id="reset-points"
                class="text-red-600 hover:text-red-800 text-sm"
              >
                Reset all stars to zero
              </button>
            </div>
          </div>
          <div class="mt-6">
            <button
              id="save-points-settings"
              class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition"
            >
              Save Settings
            </button>
          </div>
        </div>
      </div>

      <!-- Meal Input Modal -->
      <div
        id="meal-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">What did you eat?</h3>
            <button
              id="close-meal-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-1">Today's Meal</label>
              <textarea
                id="meal-notes"
                class="w-full h-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Write what you ate here..."
              ></textarea>
            </div>
          </div>
          <div class="mt-6">
            <button
              id="save-meal"
              class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"
            >
              Save
            </button>
          </div>
        </div>
      </div>

      <!-- Celebration Modal -->
      <div
        id="celebration-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center">
          <div class="mb-4">
            <div class="text-5xl mb-2">üéâ</div>
            <h3 class="text-2xl font-bold text-purple-800">Great Job!</h3>
            <p class="text-gray-600 mt-2" id="celebration-message">
              You've completed a task!
            </p>
          </div>
          <div class="mt-6">
            <button
              id="close-celebration"
              class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition"
            >
              Awesome!
            </button>
          </div>
        </div>
      </div>

      <!-- Proof Upload Modal -->
      <div
        id="proof-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800" id="proof-modal-title">
              Upload Proof
            </h3>
            <button
              id="close-proof-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <p class="text-sm text-gray-600 mb-4" id="proof-modal-description">
            Add a photo or screenshot to request approval.
          </p>
          <div class="space-y-4">
            <input
              type="file"
              id="proof-file"
              accept="image/*"
              capture="environment"
              class="w-full"
            />
            <div id="proof-preview-wrapper" class="hidden">
              <p class="text-sm text-gray-600 mb-2">Preview</p>
              <img
                id="proof-preview"
                class="w-full rounded-md border border-gray-200"
                alt="Proof preview"
              />
            </div>
          </div>
          <div class="mt-6 flex gap-2">
            <button
              id="submit-proof"
              class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Submit for Approval
            </button>
            <button
              id="cancel-proof"
              class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Admin Login Modal -->
      <div
        id="admin-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Admin Access</h3>
            <button
              id="close-admin-modal"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <p class="text-sm text-gray-600 mb-4">
            Enter the parent/admin passcode to manage tasks and approvals.
          </p>
          <div class="space-y-4">
            <input
              type="password"
              id="admin-passcode"
              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Passcode"
            />
            <p id="admin-error" class="text-sm text-red-600 hidden">
              Incorrect passcode. Try again.
            </p>
          </div>
          <div class="mt-6 flex gap-2">
            <button
              id="admin-login"
              class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition"
            >
              Unlock Admin
            </button>
            <button
              id="admin-cancel"
              class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="setup-screen"
      class="fixed inset-0 z-50 bg-[#fdf5e6] flex items-center justify-center p-6 hidden"
    >
      <div class="cookie-panel p-8 w-full max-w-sm text-center">
        <h1 class="text-3xl font-bold mb-4 cookie-title">Bake Your Cookie</h1>
        <input
          type="text"
          id="name-input"
          placeholder="Cookie Name..."
          class="w-full p-3 border-2 border-amber-200 rounded-2xl mb-6 text-center focus:border-amber-500 outline-none"
        />
        <button
          onclick="bakeCookie()"
          class="w-full bg-[#8b4513] text-white py-4 rounded-2xl font-bold shadow-lg"
        >
          START ADVENTURE
        </button>
      </div>
    </div>

    <div
      id="level-up-modal"
      class="fixed inset-0 z-50 level-up-overlay flex items-center justify-center hidden p-6 text-center"
    >
      <div class="level-up-card rounded-[40px] p-8 relative">
        <h1 class="text-4xl font-bold text-amber-700">LEVEL UP!</h1>
        <div class="text-8xl my-6">üëë</div>
        <button
          onclick="closeLevelUp()"
          class="bg-amber-600 text-white px-8 py-3 rounded-full font-bold"
        >
          AWESOME!
        </button>
      </div>
    </div>

    <div
      id="avatar-builder-modal"
      class="fixed inset-0 z-50 bg-[#fdf5e6]/95 backdrop-blur-sm flex items-center justify-center p-6 hidden"
    >
      <div class="cookie-panel p-6 w-full max-w-lg text-center relative">
        <button
          onclick="document.getElementById('avatar-builder-modal').classList.add('hidden')"
          class="absolute top-4 right-4 text-xl text-amber-800 hover:text-amber-950"
          aria-label="Close cookie collection"
        >
          ‚úï
        </button>
        <h2 class="text-2xl font-bold mb-4 cookie-title">Cookie Collection</h2>

        <div class="flex justify-around items-center mb-4">
          <div id="avatar-preview" class="cookie-avatar-pill"></div>
        </div>

        <p class="text-sm text-amber-800 mb-4">
          Unlock cookies with crystals and select your favorite.
        </p>

        <div id="cookie-collection-grid" class="cookie-collection-grid mb-6"></div>

        <button
          onclick="document.getElementById('avatar-builder-modal').classList.add('hidden')"
          class="text-sm text-amber-800 underline"
        >
          Close
        </button>
      </div>
    </div>

    <div
      id="shop-modal"
      class="fixed inset-0 z-50 bg-[#fdf5e6]/95 backdrop-blur-sm flex items-center justify-center p-6 hidden"
    >
      <div class="cookie-panel p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold cookie-title">
            The Magic Oven (Shop)
          </h2>
          <button
            onclick="document.getElementById('shop-modal').classList.add('hidden')"
            class="text-xl"
          >
            ‚úï
          </button>
        </div>

        <div id="shop-items-list" class="space-y-4 max-h-80 overflow-y-auto">
          <!-- Items injected here -->
        </div>

        <button
          onclick="openShop()"
          class="w-full mt-4 bg-gray-300 text-gray-500 py-3 rounded-2xl font-bold"
        >
          Refresh Shop
        </button>
      </div>
    </div>

    <script src="https://unpkg.com/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
    <script>
      // Initial data (loaded from /data/default-tasks.json)
      let scheduleItems = [];
      let weeklyChores = [];
      let monthlyChores = [];
      let dailyBonusMissions = [];

      let rewards = [
        { id: 1, name: "30 minutes extra screen time", points: 20, icon: "üì±" },
        { id: 2, name: "Choose dinner one night", points: 50, icon: "üçï" },
        { id: 3, name: "New craft supplies", points: 75, icon: "üß∂" },
        { id: 4, name: "Trip to favorite store", points: 100, icon: "üõçÔ∏è" },
      ];

      let habitCategories = [
        {
          name: "Personal",
          items: [
            { id: "personal-brush-teeth-am", label: "Brush teeth (AM)" },
            { id: "personal-brush-teeth-pm", label: "Brush teeth (PM)" },
            { id: "personal-wash-face-am", label: "Wash face (AM)" },
            { id: "personal-wash-face-pm", label: "Wash face (PM)" },
            { id: "personal-shower", label: "Shower" },
          ],
        },
        {
          name: "Room",
          items: [
            {
              id: "room-removed-dishes-trash",
              label: "Removed dishes & trash",
            },
            { id: "room-put-laundry-away", label: "Put laundry away" },
            {
              id: "room-removed-dirty-laundry",
              label: "Removed dirty laundry",
            },
            { id: "room-put-crafts-away", label: "Put crafts away" },
            { id: "room-made-bed", label: "Made bed" },
            { id: "room-washed-bedding", label: "Washed bedding" },
            { id: "room-vacuumed", label: "Vacuumed" },
          ],
        },
        {
          name: "House",
          items: [
            { id: "house-dogs-water-am", label: "Gave dogs water (AM)" },
            { id: "house-dogs-water-pm", label: "Gave dogs water (PM)" },
            { id: "house-picked-up-kids", label: "Picked up the kids" },
            { id: "house-folded-laundry", label: "Folded laundry" },
            {
              id: "house-watched-kids",
              label: "Watched the kids",
              requiresDuration: true,
            },
            { id: "house-swept-kitchen", label: "Swept the kitchen" },
            { id: "house-swept-bonus-room", label: "Swept the bonus room" },
            { id: "house-put-dishes-away", label: "Put dishes away" },
            { id: "house-loaded-dishwasher", label: "Loaded dishwasher" },
            { id: "house-washed-pots-pans", label: "Washed pots/pans" },
            { id: "house-wiped-counters", label: "Wiped the counters" },
            { id: "house-cleaned-table", label: "Cleaned up the table" },
            {
              id: "house-cleaned-bonus-room",
              label: "Cleaned up the bonus room",
            },
            { id: "house-vacuumed-rug", label: "Vacuumed the rug" },
            { id: "house-cleaned-back-door", label: "Cleaned the back door" },
            { id: "house-cleaned-front-door", label: "Cleaned the front door" },
            {
              id: "house-downstairs-bathroom-mirror",
              label: "Downstairs bathroom mirror",
            },
            {
              id: "house-upstairs-bathroom-mirror",
              label: "Upstairs bathroom mirror",
            },
            {
              id: "house-wiped-bathroom-counter-upstairs",
              label: "Wiped bathroom counter upstairs",
            },
            {
              id: "house-wiped-bathroom-counter-downstairs",
              label: "Wiped bathroom counter downstairs",
            },
            {
              id: "house-cleaned-kitchen-windows",
              label: "Cleaned kitchen windows",
            },
          ],
        },
        {
          name: "Yard",
          items: [
            { id: "yard-picked-trash", label: "Picked up trash in yard" },
            { id: "yard-picked-toys", label: "Picked up toys in yard" },
            { id: "yard-dog-poop", label: "Dog poop" },
            { id: "yard-weed-removal", label: "Weed removal" },
          ],
        },
      ];

      const habitsStorageKey = "habitTrackerData";
      const missionsStorageKey = `missions:${HOUSEHOLD_ID}:${PERSON_ID}`;

      // Settings
      let settings = {
        pointsEnabled: true,
        defaultPoints: {
          dailyTask: 5,
          weeklyChore: 10,
          monthlyChore: 20,
        },
      };

      let userPoints = 0;
      let pendingPoints = 0;
      let isAdmin = false;
      let scheduleRefactorActive = false;
      const adminPasscode = "1234";
      const maxPoints = 200;
      let dailyNotes = "";
      let mealNotes = "";
      let selectedMood = null;

      // DOM Elements
      const currentDateEl = document.getElementById("current-date");
      const currentTimeEl = document.getElementById("current-time");
      const progressBarEl = document.getElementById("progress-bar");
      const progressTextEl = document.getElementById("progress-text");
      const scheduleContainer = document.getElementById("schedule-container");
      const anytimeSection = document.getElementById("anytime-section");
      const anytimeContainer = document.getElementById("anytime-container");
      const weeklyContainer = document.getElementById("weekly-container");
      const monthlyContainer = document.getElementById("monthly-container");
      const dailyBonusContainer = document.getElementById("daily-bonus-container");
      const habitsContainer = document.getElementById("habits-container");
      const rewardsContainer = document.getElementById("rewards-container");
      const pointsDisplay = document.getElementById("points-display");
      const pointsTotalDisplay = document.getElementById(
        "points-total-earnings"
      );
      const pointsProgress = document.getElementById("points-progress");
      const pendingPointsDisplay = document.getElementById(
        "pending-points-display"
      );
      const pointsCard = document.getElementById("points-card");
      const moneyTotalEarnings = document.getElementById("money-total-earnings");
      const moneyPendingEarnings = document.getElementById(
        "money-pending-earnings"
      );
      const moneyCurrentBalance = document.getElementById(
        "money-current-balance"
      );
      const pointsDisplayContainer = document.getElementById(
        "points-display-container"
      );
      const editModal = document.getElementById("edit-modal");
      const choreModal = document.getElementById("chore-modal");
      const rewardModal = document.getElementById("reward-modal");
      const pointsModal = document.getElementById("points-modal");
      const mealModal = document.getElementById("meal-modal");

      function handleMissionDelete(event) {
        const button = event.target.closest(".delete-mission");
        if (!button || !isAdmin) return;
        const scope = button.dataset.scope;
        const id = parseInt(button.dataset.id, 10);
        if (!id) return;
        if (scope === "weekly") {
          weeklyChores = weeklyChores.filter((m) => m.id !== id);
          renderWeeklyChores();
        } else if (scope === "monthly") {
          monthlyChores = monthlyChores.filter((m) => m.id !== id);
          renderMonthlyChores();
        } else if (scope === "daily") {
          dailyBonusMissions = dailyBonusMissions.filter((m) => m.id !== id);
          renderDailyBonusMissions();
        }
        saveMissionsToStorage();
      }

      if (weeklyContainer) weeklyContainer.addEventListener("click", handleMissionDelete);
      if (monthlyContainer) monthlyContainer.addEventListener("click", handleMissionDelete);
      if (dailyBonusContainer) dailyBonusContainer.addEventListener("click", handleMissionDelete);
      const celebrationModal = document.getElementById("celebration-modal");
      const celebrationMessage = document.getElementById("celebration-message");
      const dailyNotesEl = document.getElementById("daily-notes");
      const moodButtons = document.querySelectorAll(".mood-btn");
      const moodNoteEl = document.getElementById("mood-note");
      const moodStatusEl = document.getElementById("mood-status");
      const journalEntryEl = document.getElementById("journal-entry");
      const proofModal = document.getElementById("proof-modal");
      const proofModalTitle = document.getElementById("proof-modal-title");
      const proofModalDescription = document.getElementById(
        "proof-modal-description"
      );
      const proofFileInput = document.getElementById("proof-file");
      const proofPreviewWrapper = document.getElementById(
        "proof-preview-wrapper"
      );
      const proofPreview = document.getElementById("proof-preview");
      const adminModal = document.getElementById("admin-modal");
      const adminPasscodeInput = document.getElementById("admin-passcode");
      const adminError = document.getElementById("admin-error");
      const adminToggle = document.getElementById("admin-toggle");
      const habitCategoryInput = document.getElementById(
        "habit-category-input"
      );
      const habitItemInput = document.getElementById("habit-item-input");
      const habitItemAdd = document.getElementById("habit-item-add");
      const habitSaveButton = document.getElementById("habit-save");

      // Tab functionality
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tabName = button.getAttribute("data-tab");

          // Update button styles
          tabButtons.forEach((btn) => {
            if (btn === button) {
              btn.classList.add("active");
            } else {
              btn.classList.remove("active");
            }
          });

          // Show/hide tab content
          tabContents.forEach((content) => {
            if (content.id === `${tabName}-tab`) {
              content.classList.remove("hidden");
            } else {
              content.classList.add("hidden");
            }
          });
        });
      });

      async function bootstrapApp() {
        await loadDefaultTasks();
        await loadDefaultMissions();
        loadMissionsFromStorage();
        updateDateTime();
        updatePointsDisplay();
        await loadPointsFromServer();
        await loadTodayTasks().finally(() => {
          renderSchedule();
          updateProgress();
        });
        await loadDailyNotes();
        loadMoodCheckin();
        loadJournal();
        loadHabitsFromStorage();
        await loadHabitsFromServer().finally(() => {
          renderHabits();
        });
        renderWeeklyChores();
        renderDailyBonusMissions();
        renderMonthlyChores();
        renderRewards();
        updateAdminVisibility();
        await checkFirstTime();
      }

      // Helper functions
      function getTodayString() {
        const today = new Date();
        return today.toISOString().split("T")[0];
      }

      function getYesterdayString() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        return yesterday.toISOString().split("T")[0];
      }

      function isSchoolTask(item) {
        if (!item || !item.type) return false;
        return item.type === "focus";
      }

      function formatTime(timeString) {
        if (!timeString) {
          return "";
        }
        const [hours, minutes] = timeString.split(":");
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? "PM" : "AM";
        const formattedHour = hour % 12 || 12;
        return `${formattedHour}:${minutes} ${ampm}`;
      }

      function formatTaskType(type) {
        const labels = {
          focus: "Focus Block",
          break: "Break",
          chore: "Mission",
          personal: "Personal",
        };
        return labels[type] || type;
      }

      function getDayName(dateString) {
        const date = dateString
          ? new Date(`${dateString}T00:00:00`)
          : new Date();
        return date.toLocaleDateString("en-US", { weekday: "long" });
      }

      function getMonthName(date) {
        return date.toLocaleDateString("en-US", { month: "long" });
      }

      function getWeekOfMonth(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const firstWeekday = (firstDay.getDay() + 6) % 7; // Monday=0
        return Math.floor((date.getDate() + firstWeekday - 1) / 7) + 1;
      }

      function getWeekRange(year, monthIndex, weekOfMonth) {
        const firstDay = new Date(year, monthIndex, 1);
        const firstWeekday = (firstDay.getDay() + 6) % 7;
        const startDay = 1 + (weekOfMonth - 1) * 7 - firstWeekday;
        const startDate = new Date(year, monthIndex, startDay);
        const endDate = new Date(year, monthIndex, startDay + 6);
        return { startDate, endDate };
      }

      function getMonthRange(year, monthIndex) {
        const startDate = new Date(year, monthIndex, 1);
        const endDate = new Date(year, monthIndex + 1, 0);
        return { startDate, endDate };
      }

      function listDatedEntries(prefix) {
        const entries = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key || !key.startsWith(prefix)) continue;
          const dateString = key.slice(prefix.length);
          const date = new Date(`${dateString}T00:00:00`);
          if (Number.isNaN(date.getTime())) continue;
          entries.push({ date, value: localStorage.getItem(key) });
        }
        return entries;
      }

      function isDateInRange(date, startDate, endDate) {
        const time = date.getTime();
        return time >= startDate.getTime() && time <= endDate.getTime();
      }

      function countMoodEntriesInRange(startDate, endDate) {
        const prefix = `mood:${HOUSEHOLD_ID}:${PERSON_ID}:`;
        const entries = listDatedEntries(prefix);
        return entries.filter((entry) => {
          if (!isDateInRange(entry.date, startDate, endDate)) return false;
          try {
            const parsed = JSON.parse(entry.value || "{}");
            return !!parsed.mood;
          } catch {
            return false;
          }
        }).length;
      }

      function countJournalEntriesInRange(startDate, endDate) {
        const prefix = `journal:${HOUSEHOLD_ID}:${PERSON_ID}:`;
        const entries = listDatedEntries(prefix);
        return entries.filter((entry) => {
          if (!isDateInRange(entry.date, startDate, endDate)) return false;
          return (entry.value || "").trim().length > 0;
        }).length;
      }

      function getRequirementCount(type, startDate, endDate) {
        if (type === "mood") {
          return countMoodEntriesInRange(startDate, endDate);
        }
        if (type === "journal") {
          return countJournalEntriesInRange(startDate, endDate);
        }
        return 0;
      }

      function getScheduleItemsForDate(dateString) {
        const dayName = getDayName(dateString);
        return scheduleItems.filter((item) => {
          if (
            Array.isArray(item.recurringDays) &&
            item.recurringDays.length > 0
          ) {
            return item.recurringDays.includes(dayName);
          }
          return true;
        });
      }

      function sortScheduleByTime(items) {
        return [...items].sort((a, b) => {
          const aTime = a.time || "";
          const bTime = b.time || "";
          if (!aTime && !bTime) {
            return 0;
          }
          if (!aTime) {
            return 1;
          }
          if (!bTime) {
            return -1;
          }
          return aTime.localeCompare(bTime);
        });
      }

      function timeToMinutes(timeString) {
        if (!timeString) return null;
        const [hours, minutes] = timeString.split(":").map(Number);
        if (!Number.isFinite(hours) || !Number.isFinite(minutes)) return null;
        return hours * 60 + minutes;
      }

      function minutesToTime(totalMinutes) {
        const normalized =
          ((totalMinutes % 1440) + 1440) % 1440;
        const hours = Math.floor(normalized / 60);
        const minutes = normalized % 60;
        return `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}`;
      }

      function roundUpToIncrement(date, incrementMinutes) {
        const totalMinutes = date.getHours() * 60 + date.getMinutes();
        const rounded =
          Math.ceil(totalMinutes / incrementMinutes) * incrementMinutes;
        return rounded;
      }

      function getItemDurationMinutes(item) {
        const start = timeToMinutes(item.time);
        const end = timeToMinutes(item.endTime);
        if (start !== null && end !== null) {
          let delta = end - start;
          if (delta <= 0) {
            delta += 1440;
          }
          return delta;
        }
        return 30;
      }

      function reorderScheduleForNow(items) {
        const now = new Date();
        const currentTimeValue = `${now
          .getHours()
          .toString()
          .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
        let cursorMinutes = roundUpToIncrement(now, 15);
        const sortedSchedule = sortScheduleByTime(items);
        const incomplete = sortedSchedule.filter((item) => !item.completed);
        const completed = sortedSchedule.filter((item) => item.completed);
        const timedIncomplete = incomplete.filter((item) => item.time);
        const anytimeIncomplete = incomplete.filter((item) => !item.time);
        const pivotIndex = timedIncomplete.findIndex(
          (item) => item.time >= currentTimeValue
        );
        const reorderedTimed =
          pivotIndex === -1
            ? timedIncomplete
            : [
                ...timedIncomplete.slice(pivotIndex),
                ...timedIncomplete.slice(0, pivotIndex),
              ];
        const refactoredTimed = reorderedTimed.map((item) => {
          const duration = getItemDurationMinutes(item);
          const startMinutes = cursorMinutes;
          const endMinutes = cursorMinutes + duration;
          cursorMinutes = endMinutes;
          const updated = { ...item, time: minutesToTime(startMinutes) };
          if (item.endTime) {
            updated.endTime = minutesToTime(endMinutes);
          }
          return updated;
        });
        return [...refactoredTimed, ...anytimeIncomplete, ...completed];
      }

      function slugify(text) {
        return text
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)+/g, "");
      }

      function loadHabitsFromStorage() {
        const saved = localStorage.getItem(habitsStorageKey);
        if (!saved) {
          return;
        }
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            habitCategories = parsed;
          }
        } catch (error) {
          console.warn("Failed to parse habits storage", error);
        }
      }

      function loadHabitsFromServer() {
        return apiGetJson(
          `/habits?householdId=${encodeURIComponent(
            HOUSEHOLD_ID
          )}&personId=${encodeURIComponent(PERSON_ID)}`
        )
          .then((data) => {
            if (Array.isArray(data.habits)) {
              habitCategories = data.habits;
              saveHabitsToStorage();
            }
          })
          .catch(() => {
            // Ignore load errors to allow offline usage.
          });
      }

      function saveHabitsToStorage() {
        localStorage.setItem(habitsStorageKey, JSON.stringify(habitCategories));
      }

      function saveHabitsToServer() {
        return apiPostJson("/habits", {
          householdId: HOUSEHOLD_ID,
          personId: PERSON_ID,
          habits: habitCategories,
        }).catch(() => {
          // Ignore save errors to allow offline usage.
        });
      }

      function renderHabits() {
        habitsContainer.innerHTML = "";

        habitCategories.forEach((category) => {
          const section = document.createElement("div");
          section.className = "bg-white rounded-lg shadow-sm p-4";

          const itemsHtml = category.items
            .map((item) => {
              const durationValue = item.duration || "";
              const durationField = item.requiresDuration
                ? `<input type="text" data-id="${item.id}" class="habit-duration ml-2 w-28 border border-gray-300 rounded-md px-2 py-1 text-sm" placeholder="Duration" value="${durationValue}">`
                : "";
              const streakValue = Number.isFinite(item.streak)
                ? item.streak
                : 0;
              return `
                        <div class="flex items-center justify-between gap-2 py-1">
                            <label class="flex items-center gap-2 text-sm text-gray-700">
                                <input type="checkbox" data-id="${
                                  item.id
                                }" class="habit-toggle" ${
                item.completed ? "checked" : ""
              }>
                                <span>${item.label}</span>
                            </label>
                            <div class="flex items-center gap-2">
                              <span class="text-xs font-semibold text-amber-800 bg-amber-100 px-2 py-1 rounded-full">
                                Streak ${streakValue}
                              </span>
                              ${durationField}
                            </div>
                        </div>
                    `;
            })
            .join("");

          section.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-800">${
                          category.name
                        }</h3>
                    </div>
                    <div class="space-y-1">
                        ${
                          itemsHtml ||
                          '<p class="text-sm text-gray-500">No tasks yet.</p>'
                        }
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <input type="text" class="habit-new flex-grow border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Add a new task...">
                        <button class="habit-add bg-blue-100 text-blue-600 px-3 py-2 rounded-md hover:bg-blue-200 transition">Add</button>
                    </div>
                `;

          habitsContainer.appendChild(section);

          const addButton = section.querySelector(".habit-add");
          const newInput = section.querySelector(".habit-new");
          addButton.addEventListener("click", () => {
            const value = newInput.value.trim();
            if (!value) {
              return;
            }
            const id = `${slugify(category.name)}-${slugify(value)}`;
            category.items.push({ id, label: value, completed: false });
            newInput.value = "";
            saveHabitsToStorage();
            saveHabitsToServer();
            renderHabits();
          });
        });

        habitsContainer.querySelectorAll(".habit-toggle").forEach((toggle) => {
          toggle.addEventListener("change", () => {
            const id = toggle.dataset.id;
            const today = getTodayString();
            const yesterday = getYesterdayString();
            habitCategories.forEach((category) => {
              const item = category.items.find((entry) => entry.id === id);
              if (item) {
                item.completed = toggle.checked;
                if (toggle.checked) {
                  if (item.lastCompleted !== today) {
                    if (item.lastCompleted === yesterday) {
                      item.streak = (item.streak || 0) + 1;
                    } else {
                      item.streak = 1;
                    }
                    item.lastCompleted = today;
                  }
                } else if (item.lastCompleted === today) {
                  item.lastCompleted = null;
                  item.streak = Math.max((item.streak || 1) - 1, 0);
                }
              }
            });
            saveHabitsToStorage();
            saveHabitsToServer();
            renderHabits();
          });
        });

        habitsContainer.querySelectorAll(".habit-duration").forEach((input) => {
          input.addEventListener("change", () => {
            const id = input.dataset.id;
            habitCategories.forEach((category) => {
              const item = category.items.find((entry) => entry.id === id);
              if (item) {
                item.duration = input.value.trim();
              }
            });
            saveHabitsToStorage();
            saveHabitsToServer();
          });
        });
      }

      function addHabitFromInputs() {
        if (!habitCategoryInput || !habitItemInput) {
          return;
        }
        const categoryName = habitCategoryInput.value.trim();
        const itemLabel = habitItemInput.value.trim();
        if (!categoryName || !itemLabel) {
          return;
        }
        let category = habitCategories.find(
          (entry) => entry.name.toLowerCase() === categoryName.toLowerCase()
        );
        if (!category) {
          category = { name: categoryName, items: [] };
          habitCategories.push(category);
        }
        const id = `${slugify(category.name)}-${slugify(itemLabel)}`;
        if (!category.items.find((item) => item.id === id)) {
          category.items.push({ id, label: itemLabel, completed: false });
        }
        habitCategoryInput.value = "";
        habitItemInput.value = "";
        saveHabitsToStorage();
        saveHabitsToServer();
        renderHabits();
      }

      function handleHabitSave() {
        if (!habitSaveButton) return;
        habitSaveButton.disabled = true;
        const originalText = habitSaveButton.textContent;
        habitSaveButton.textContent = "Saving...";
        saveHabitsToStorage();
        Promise.resolve(saveHabitsToServer()).finally(() => {
          habitSaveButton.textContent = "Saved!";
          window.setTimeout(() => {
            habitSaveButton.textContent = originalText;
            habitSaveButton.disabled = false;
          }, 800);
        });
      }

      function updateDateTime() {
        const now = new Date();
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        currentDateEl.textContent = now.toLocaleDateString("en-US", options);

        const timeOptions = {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        };
        currentTimeEl.textContent = now.toLocaleTimeString(
          "en-US",
          timeOptions
        );

        // Highlight current task
        updateCurrentTask();
      }

      function updateCurrentTask() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTimeValue = `${currentHour
          .toString()
          .padStart(2, "0")}:${currentMinute.toString().padStart(2, "0")}`;

        // Sort schedule by time
        const sortedSchedule = sortScheduleByTime(scheduleItems);

        // Find the current task
        let currentTask = null;

        for (let i = 0; i < sortedSchedule.length; i++) {
          const item = sortedSchedule[i];
          const nextItem = sortedSchedule[i + 1];

          if (
            item.time <= currentTimeValue &&
            (!nextItem || nextItem.time > currentTimeValue)
          ) {
            currentTask = item;
            break;
          }
        }

        // Update UI to highlight current task
        document.querySelectorAll(".schedule-item").forEach((item) => {
          item.classList.remove("current-task", "bg-blue-50");

          if (currentTask && item.dataset.id == currentTask.id) {
            item.classList.add("current-task", "bg-blue-50");
          }
        });
      }

      function updateProgress() {
        const totalTasks = scheduleItems.length;
        const completedTasks = scheduleItems.filter(
          (item) => item.completed
        ).length;

        const progressPercentage =
          totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        progressBarEl.style.width = `${progressPercentage}%`;
        progressTextEl.textContent = `${progressPercentage}%`;
        updateCookieStarFromSchedule();
      }

      function triggerLevelUpAnimation() {
        const modal = document.getElementById("level-up-modal");
        if (modal) {
          modal.classList.remove("hidden");
        }
      }

      function closeLevelUp() {
        const modal = document.getElementById("level-up-modal");
        if (modal) {
          modal.classList.add("hidden");
        }
      }

      function updatePointsDisplay() {
        pointsDisplay.textContent = userPoints;
        pendingPointsDisplay.textContent = pendingPoints;
        if (pointsTotalDisplay) {
          pointsTotalDisplay.textContent = userPoints + pendingPoints;
        }
        const percentage = Math.min((userPoints / maxPoints) * 100, 100);
        pointsProgress.style.width = `${percentage}%`;

        // Show/hide points display based on settings
        if (settings.pointsEnabled) {
          if (pointsCard) {
            pointsCard.classList.remove("hidden");
          }
          document.getElementById("add-reward").classList.remove("hidden");
        } else {
          if (pointsCard) {
            pointsCard.classList.add("hidden");
          }
          document.getElementById("add-reward").classList.add("hidden");
        }

        if (moneyTotalEarnings) {
          moneyTotalEarnings.textContent = "0.00";
        }
        if (moneyPendingEarnings) {
          moneyPendingEarnings.textContent = "0.00";
        }
        if (moneyCurrentBalance) {
          moneyCurrentBalance.textContent = "0.00";
        }
      }

      function getTypeClass(type) {
        switch (type) {
          case "focus":
            return "focus-block";
          case "break":
            return "break-block";
          case "chore":
            return "chore-block";
          case "personal":
            return "personal-block";
          default:
            return "";
        }
      }

      function getTypeColor(type) {
        switch (type) {
          case "focus":
            return "bg-blue-50";
          case "break":
            return "bg-green-50";
          case "chore":
            return "bg-amber-50";
          case "personal":
            return "bg-purple-50";
          default:
            return "bg-white";
        }
      }

      function isBreakItem(item) {
        return item && item.type === "break";
      }

      function isMealItem(item) {
        if (!item) {
          return false;
        }
        if (item.hasMealInput) {
          return true;
        }
        const taskText = (item.task || "").toLowerCase();
        return (
          taskText.includes("breakfast") ||
          taskText.includes("lunch") ||
          taskText.includes("dinner") ||
          taskText.includes("snack") ||
          taskText.includes("meal")
        );
      }

      function getEffectivePoints(item) {
        const basePoints = Number(item?.points || 0);
        return isBreakItem(item) || isMealItem(item) ? 0 : basePoints;
      }

      function getItemByType(type, id) {
        if (type === "schedule") {
          return scheduleItems.find((item) => item.id === id);
        }
        return null;
      }

      function getAllItems() {
        return [...scheduleItems];
      }

      function areBasicsComplete() {
        const basicItems = getAllItems().filter((item) => item.isBasic);
        if (basicItems.length === 0) {
          return true;
        }
        return basicItems.every(
          (item) => item.completed && !item.pendingApproval
        );
      }

      function releasePendingRewards() {
        if (!areBasicsComplete()) {
          return;
        }

        getAllItems().forEach((item) => {
          if (item.pendingRelease && item.completed && !item.pendingApproval) {
            const itemPoints = getEffectivePoints(item);
            pendingPoints = Math.max(0, pendingPoints - itemPoints);
            userPoints += itemPoints;
            item.pendingRelease = false;
          }
        });
        updatePointsDisplay();
      }

      function requestApproval(item) {
        item.pendingApproval = true;
        item.completed = false;
        if (settings.pointsEnabled) {
          pendingPoints += getEffectivePoints(item);
          updatePointsDisplay();
        }
        if (scheduleItems.includes(item)) {
          saveCompletedTasks();
        }
      }

      function approveTask(item, label) {
        item.pendingApproval = false;
        item.completed = true;
        if (item.requiresHomeworkCheck) {
          item.completedDate = item.proofDate || getTodayString();
        }
        if (settings.pointsEnabled) {
          const itemPoints = getEffectivePoints(item);
          if (itemPoints > 0) {
            if (areBasicsComplete()) {
              pendingPoints = Math.max(0, pendingPoints - itemPoints);
              userPoints += itemPoints;
              updatePointsDisplay();
              showCelebration(`"${label}" approved! Stars added to balance.`);
            } else {
              item.pendingRelease = true;
              showCelebration(
                `"${label}" approved! Stars are pending until basics are done.`
              );
            }
          } else {
            showCelebration(`"${label}" approved!`);
          }
        } else {
          showCelebration(`"${label}" approved!`);
        }
        releasePendingRewards();
        if (scheduleItems.includes(item)) {
          saveCompletedTasks();
        }
      }

      function denyTask(item, label) {
        item.pendingApproval = false;
        item.completed = false;
        item.proofImage = "";
        item.proofDate = null;
        item.pendingRelease = false;
        if (settings.pointsEnabled) {
          pendingPoints = Math.max(0, pendingPoints - getEffectivePoints(item));
          updatePointsDisplay();
        }
        showCelebration(
          `"${label}" needs another try. Please upload a new photo.`
        );
        if (scheduleItems.includes(item)) {
          saveCompletedTasks();
        }
      }

      function openProofModal({ type, item }) {
        proofModal.dataset.type = type;
        proofModal.dataset.itemId = item.id;
        proofModalTitle.textContent = `Upload Proof for "${item.task}"`;
        proofModalDescription.textContent = item.requiresHomeworkCheck
          ? "Upload the Acellus progress screenshot. The app will auto-check for the daily star tracker."
          : "Add a photo or screenshot to request approval.";
        proofModalDescription.textContent =
          "Add a photo or screenshot to request approval.";
        proofFileInput.value = "";
        proofPreviewWrapper.classList.add("hidden");
        proofPreview.src = "";
        document.getElementById("submit-proof").disabled = true;
        proofModal.classList.remove("hidden");
      }

      function openCameraCapture({ type, item }) {
        openProofModal({ type, item });
        proofFileInput.click();
      }

      function normalizeText(text) {
        return text.toLowerCase().replace(/\s+/g, " ").trim();
      }

      function matchesAcellusTracker(text) {
        const normalized = normalizeText(text);
        const hasAcellus = normalized.includes("acellus");
        const hasStars = normalized.includes("star");
        const subjects = [
          "math",
          "science",
          "language arts",
          "reading",
          "social studies",
        ];
        const hasSubject = subjects.some((subject) =>
          normalized.includes(subject)
        );
        return hasAcellus && (hasStars || hasSubject);
      }

      async function autoReviewHomework(item) {
        if (!window.Tesseract || !item.proofImage) {
          return { approved: false, reason: "OCR unavailable" };
        }

        const result = await window.Tesseract.recognize(item.proofImage, "eng");
        const text = result?.data?.text || "";
        return { approved: matchesAcellusTracker(text), reason: text };
      }

      function renderSchedule() {
        scheduleContainer.innerHTML = "";
        anytimeContainer.innerHTML = "";

        let itemsForToday = getScheduleItemsForDate(getTodayString());
        const todayString = getTodayString();
        itemsForToday.forEach((item) => {
          if (
            item.requiresHomeworkCheck &&
            item.completedDate &&
            item.completedDate !== todayString
          ) {
            item.completed = false;
            item.pendingApproval = false;
            item.pendingRelease = false;
            item.proofImage = "";
            item.autoReviewStatus = "";
            item.completedDate = null;
            item.proofDate = null;
          }
        });
        if (scheduleRefactorActive) {
          itemsForToday = reorderScheduleForNow(itemsForToday);
        } else {
          itemsForToday = sortScheduleByTime(itemsForToday);
        }

        const renderScheduleItems = (
          items,
          targetContainer,
          showAnytimeLabel
        ) => {
          items.forEach((item) => {
            const itemEl = document.createElement("div");
            const requiresPhoto = item.requiresPhoto || isSchoolTask(item);
            if (requiresPhoto && !item.requiresPhoto) {
              item.requiresPhoto = true;
            }
            itemEl.className = `schedule-item task-card cookie-task flex items-center p-3 rounded-lg shadow-sm ${getTypeClass(
              item.type
            )} ${getTypeColor(item.type)} ${item.completed ? "completed" : ""}`;
            itemEl.dataset.id = item.id;

            let timeDisplay = item.time
              ? formatTime(item.time)
              : showAnytimeLabel
              ? "Anytime"
              : "";
            if (item.endTime) {
              timeDisplay += ` - ${formatTime(item.endTime)}`;
            }

            const isPending = item.pendingApproval;
            const isPendingRelease = item.pendingRelease;
            const isBasic = item.isBasic;
            const autoStatus = item.autoReviewStatus;

            const itemPoints = getEffectivePoints(item);
            let pointsDisplay = "";
            if (settings.pointsEnabled && itemPoints > 0) {
              pointsDisplay =
                '<span class="text-xs font-semibold text-blue-600 ml-2">‚≠ê</span>';
            }
            const cameraButton = requiresPhoto
              ? `<button class="open-camera ml-2 w-6 h-6 rounded-full border border-gray-300 flex items-center justify-center text-gray-600 hover:text-gray-800 hover:border-gray-400 ${
                  isPending ? "opacity-50 cursor-not-allowed" : ""
                }" ${
                  isPending ? 'aria-disabled="true"' : ""
                } aria-label="Open camera">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h3l2-2h8l2 2h3a1 1 0 011 1v10a2 2 0 01-2 2H5a2 2 0 01-2-2V8a1 1 0 011-1z" />
                    <circle cx="12" cy="13" r="3" stroke-width="2"></circle>
                  </svg>
                </button>`
              : "";

            let statusLabel = "";
            let approvalActions = "";
            let proofPreviewHtml = "";

            if (requiresPhoto) {
              if (isPending) {
                statusLabel =
                  '<span class="ml-2 text-xs font-semibold text-amber-600">Pending approval</span>';
                approvalActions = `
                                <div class="flex items-center gap-2 ml-3">
                                    <button class="admin-only approve-task text-xs bg-emerald-500 text-white px-2 py-1 rounded-md hover:bg-emerald-600">Approve</button>
                                    <button class="admin-only deny-task text-xs bg-rose-100 text-rose-600 px-2 py-1 rounded-md hover:bg-rose-200">Deny</button>
                                </div>
                            `;
              } else if (item.completed) {
                statusLabel =
                  '<span class="ml-2 text-xs font-semibold text-emerald-600">Approved</span>';
              } else {
                statusLabel =
                  '<span class="ml-2 text-xs font-semibold text-gray-500">Photo required</span>';
              }
            }

            if (autoStatus === "approved") {
              statusLabel +=
                '<span class="ml-2 text-xs font-semibold text-emerald-600">Auto-approved</span>';
            } else if (autoStatus === "denied") {
              statusLabel +=
                '<span class="ml-2 text-xs font-semibold text-rose-600">Auto-denied</span>';
            }

            if (isPendingRelease) {
              statusLabel +=
                '<span class="ml-2 text-xs font-semibold text-amber-600">Pending basics</span>';
            }

            if (isBasic) {
              statusLabel +=
                '<span class="ml-2 text-blue-600" title="Required task" aria-label="Required task">üîπ</span>';
            }

            if (item.proofImage) {
              proofPreviewHtml = `<div class="mt-2"><img src="${item.proofImage}" alt="Proof preview" class="w-28 rounded-md border border-gray-200"></div>`;
            }


            itemEl.innerHTML = `
                        <div class="flex-shrink-0 w-24 text-center">
                            <span class="font-semibold text-gray-700">${timeDisplay}</span>
                        </div>
                        <div class="ml-4 flex-grow">
                            <div class="flex items-center">
                                <p class="text-gray-800">${item.task}</p>
                                ${pointsDisplay}
                                ${cameraButton}
                                ${statusLabel}
                            </div>
                            <div class="task-details">
                              ${
                                item.hasMealInput && item.completed && mealNotes
                                  ? `<p class="text-sm text-gray-600 mt-1">Ate: ${mealNotes}</p>`
                                  : ""
                              }
                              ${proofPreviewHtml}
                              ${proofPreviewHtml}
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-2 flex items-center">
                            <button class="complete-task w-6 h-6 rounded-full border-2 border-blue-500 flex items-center justify-center ${
                              item.completed ? "bg-blue-500" : ""
                            } ${
              isPending ? "opacity-50 cursor-not-allowed" : ""
            }" ${isPending ? 'aria-disabled="true"' : ""}>
                                ${
                                  item.completed
                                    ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                                    : ""
                                }
                            </button>
                            ${isAdmin ? approvalActions : ""}
                        </div>
                    `;

            targetContainer.appendChild(itemEl);

            itemEl.addEventListener("click", (event) => {
              if (
                event.target.closest("button") ||
                event.target.closest("input") ||
                event.target.closest("textarea")
              ) {
                return;
              }
              itemEl.classList.toggle("collapsed");
            });

            // Add event listener to complete button
            const completeBtn = itemEl.querySelector(".complete-task");
            const cameraBtn = itemEl.querySelector(".open-camera");
            completeBtn.addEventListener("click", () => {
              handleScheduleItemToggle(item);
            });

            if (cameraBtn) {
              cameraBtn.addEventListener("click", (event) => {
                event.stopPropagation();
                if (item.pendingApproval) {
                  showCelebration(`"${item.task}" is waiting for approval.`);
                  return;
                }
                openCameraCapture({ type: "schedule", item });
              });
            }

            if (item.pendingApproval && isAdmin) {
              const approveBtn = itemEl.querySelector(".approve-task");
              const denyBtn = itemEl.querySelector(".deny-task");
              approveBtn.addEventListener("click", () => {
                if (!isAdmin) {
                  showCelebration("Admin sign-in required to approve tasks.");
                  return;
                }
                approveTask(item, item.task);
                renderSchedule();
                updateProgress();
              });
              denyBtn.addEventListener("click", () => {
                if (!isAdmin) {
                  showCelebration("Admin sign-in required to deny tasks.");
                  return;
                }
                denyTask(item, item.task);
                renderSchedule();
                updateProgress();
              });
            }
          });
        };

        const timedItems = itemsForToday.filter((item) => item.time);
        const anytimeItems = itemsForToday.filter((item) => !item.time);
        renderScheduleItems(timedItems, scheduleContainer, false);
        renderScheduleItems(anytimeItems, anytimeContainer, true);
        anytimeSection.classList.toggle("hidden", anytimeItems.length === 0);
        renderUnfinishedTasks(itemsForToday);

        updateCurrentTask();

        // Update daily notes textarea
        dailyNotesEl.value = dailyNotes;
        updateAdminVisibility();
      }

      function handleScheduleItemToggle(item) {
        if (item.pendingApproval) {
          showCelebration(`"${item.task}" is waiting for approval.`);
          return;
        }
        const requiresPhoto = item.requiresPhoto || isSchoolTask(item);
        if (requiresPhoto && !item.requiresPhoto) {
          item.requiresPhoto = true;
        }
        const itemPoints = getEffectivePoints(item);
        if (!item.completed) {
          if (
            item.requiresHomeworkCheck &&
            item.completedDate &&
            item.completedDate !== getTodayString()
          ) {
            showCelebration(
              "School check-offs can only be completed on the same day unless approved with a photo."
            );
            openProofModal({ type: "schedule", item });
            return;
          }
          if (requiresPhoto) {
            openProofModal({ type: "schedule", item });
            return;
          }
          if (item.hasMealInput) {
            document.getElementById("meal-notes").value = mealNotes;
            mealModal.classList.remove("hidden");
            mealModal.dataset.itemId = item.id;
            return;
          }
          item.completed = true;
          if (item.requiresHomeworkCheck) {
            item.completedDate = getTodayString();
          }
          if (settings.pointsEnabled) {
            if (itemPoints > 0) {
              if (areBasicsComplete()) {
                userPoints += itemPoints;
                updatePointsDisplay();
                showCelebration(
                  `You completed "${item.task}"! +${itemPoints} stars`
                );
              } else {
                item.pendingRelease = true;
                pendingPoints += itemPoints;
                updatePointsDisplay();
                showCelebration(
                  `You completed "${item.task}"! Stars are pending until basics are done.`
                );
              }
            } else {
              showCelebration(`You completed "${item.task}"!`);
            }
          } else {
            showCelebration(`You completed "${item.task}"!`);
          }
          renderSchedule();
          updateProgress();
          releasePendingRewards();
          saveCompletedTasks();
          return;
        }

        item.completed = false;
        if (settings.pointsEnabled) {
          userPoints = Math.max(0, userPoints - itemPoints);
          updatePointsDisplay();
        }
        if (item.pendingRelease) {
          pendingPoints = Math.max(0, pendingPoints - itemPoints);
          item.pendingRelease = false;
          updatePointsDisplay();
        }
        item.proofImage = "";
        renderSchedule();
        updateProgress();
        saveCompletedTasks();
      }

      function renderUnfinishedTasks(items) {
        const unfinishedContainer =
          document.getElementById("unfinished-container");
        if (!unfinishedContainer) {
          return;
        }
        unfinishedContainer.innerHTML = "";
        const unfinished = items.filter(
          (item) =>
            !item.completed && (item.type === "chore" || item.type === "focus")
        );
        if (unfinished.length === 0) {
          unfinishedContainer.innerHTML =
            '<p class="text-sm text-gray-500">All tasks finished!</p>';
          return;
        }

        const now = new Date();
        const currentTimeValue = `${now
          .getHours()
          .toString()
          .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
        const overdue = [];
        const upcoming = [];
        unfinished.forEach((item) => {
          if (item.time && item.time < currentTimeValue) {
            overdue.push(item);
          } else {
            upcoming.push(item);
          }
        });

        const bucketByTimeOfDay = (group) => {
          const buckets = {
            morning: [],
            afternoon: [],
            evening: [],
            anytime: [],
          };
          group.forEach((item) => {
            if (!item.time) {
              buckets.anytime.push(item);
              return;
            }
            const hour = parseInt(item.time.split(":")[0], 10);
            if (hour < 12) {
              buckets.morning.push(item);
            } else if (hour < 17) {
              buckets.afternoon.push(item);
            } else {
              buckets.evening.push(item);
            }
          });
          return buckets;
        };

        const renderItems = (items) => {
          items
            .slice()
            .sort((a, b) => (a.time || "").localeCompare(b.time || ""))
            .forEach((item) => {
              const row = document.createElement("label");
              row.className =
                "flex items-start gap-2 rounded-md border border-gray-200 px-2 py-2";
              row.innerHTML = `
            <input type="checkbox" class="mt-1" ${
              item.pendingApproval ? "disabled" : ""
            }>
            <span class="text-sm text-gray-700">
              ${item.task}
            </span>
          `;
              const checkbox = row.querySelector("input");
              checkbox.addEventListener("change", () => {
                handleScheduleItemToggle(item);
              });
              unfinishedContainer.appendChild(row);
            });
        };

        const renderBlock = (label, items) => {
          if (items.length === 0) {
            return;
          }
          const heading = document.createElement("div");
          heading.className =
            "mt-2 text-xs uppercase tracking-wide text-gray-500";
          heading.textContent = label;
          unfinishedContainer.appendChild(heading);
          renderItems(items);
        };

        const renderGroup = (label, group) => {
          if (group.length === 0) {
            return;
          }
          const heading = document.createElement("div");
          heading.className = "text-xs uppercase tracking-wide text-gray-500";
          heading.textContent = label;
          unfinishedContainer.appendChild(heading);
          const buckets = bucketByTimeOfDay(group);
          renderBlock("Morning", buckets.morning);
          renderBlock("Afternoon", buckets.afternoon);
          renderBlock("Evening", buckets.evening);
          renderBlock("Anytime", buckets.anytime);
        };

        renderGroup("Earlier", overdue);
        if (overdue.length && upcoming.length) {
          const divider = document.createElement("div");
          divider.className = "border-t border-gray-200 my-2";
          unfinishedContainer.appendChild(divider);
        }
        renderGroup("Coming up", upcoming);
      }

      function renderMissionRequirements(requirements, startDate, endDate) {
        if (!requirements.length) {
          return { html: '<p class="text-xs text-gray-500">No requirements.</p>', completed: false };
        }
        let completed = true;
        const rows = requirements
          .filter((req) => req && req.type && req.target)
          .map((req) => {
            const count = getRequirementCount(req.type, startDate, endDate);
            const target = parseInt(req.target, 10);
            const progress = Math.min((count / target) * 100, 100);
            if (count < target) completed = false;
            return `
              <div class="mt-2">
                <div class="flex items-center justify-between text-xs text-gray-600">
                  <span>${req.type === "mood" ? "Mood check-ins" : "Journal entries"}</span>
                  <span>${count}/${target}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                </div>
              </div>
            `;
          })
          .join("");
        return { html: rows, completed };
      }

      function renderDailyBonusMissions() {
        dailyBonusContainer.innerHTML = "";
        const today = new Date();
        const dayName = today.toLocaleDateString("en-US", { weekday: "long" });
        const days = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];

        days.forEach((day) => {
          const missions = dailyBonusMissions.filter(
            (mission) => mission.dayOfWeek === day
          );
          if (!missions.length) return;
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-lg shadow-md";
          card.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-2">${day}${
              day === dayName ? " (Today)" : ""
            }</h3>
            <div class="space-y-3 missions-list" data-day="${day}"></div>
          `;
          dailyBonusContainer.appendChild(card);
          const list = card.querySelector(".missions-list");
          missions.forEach((mission) => {
            const startDate = new Date(
              today.getFullYear(),
              today.getMonth(),
              today.getDate()
            );
            const endDate = new Date(startDate);
            const requirementHtml = day === dayName
              ? renderMissionRequirements(mission.requirements || [], startDate, endDate)
              : { html: '<p class="text-xs text-gray-500">Not active today.</p>', completed: false };
            const completed = requirementHtml.completed;
            const missionEl = document.createElement("div");
            missionEl.className = `p-3 rounded-md border ${
              completed ? "border-emerald-300 bg-emerald-50" : "border-gray-200"
            }`;
            missionEl.innerHTML = `
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="font-semibold text-gray-800">${mission.title}</div>
                  ${requirementHtml.html}
                </div>
                <div class="flex items-center gap-2">
                  ${
                    completed
                      ? '<span class="text-xs text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full">Complete</span>'
                      : ""
                  }
                  <button class="admin-only delete-mission text-red-500 hover:text-red-700" data-scope="daily" data-id="${mission.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H3.5A1.5 1.5 0 002 5.5V6h16v-.5A1.5 1.5 0 0016.5 4H15V3a1 1 0 00-1-1H6zm3 6a1 1 0 012 0v6a1 1 0 11-2 0V8zm-4 0a1 1 0 112 0v6a1 1 0 11-2 0V8zm8 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg>
                  </button>
                </div>
              </div>
            `;
            list.appendChild(missionEl);
          });
        });

        if (!dailyBonusContainer.children.length) {
          dailyBonusContainer.innerHTML =
            '<p class="text-sm text-gray-500">No daily bonus missions yet.</p>';
        }
      }

      function renderWeeklyChores() {
        weeklyContainer.innerHTML = "";
        const now = new Date();
        const currentWeek = `Week ${getWeekOfMonth(now)}`;
        const weeks = ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"];

        weeks.forEach((weekLabel) => {
          const missions = weeklyChores.filter(
            (mission) => mission.weekOfMonth === weekLabel
          );
          if (!missions.length) return;
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-lg shadow-md";
          card.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-2">${weekLabel}${
              weekLabel === currentWeek ? " (Current Week)" : ""
            }</h3>
            <div class="space-y-3 missions-list" data-week="${weekLabel}"></div>
          `;
          weeklyContainer.appendChild(card);
          const list = card.querySelector(".missions-list");
          const weekNumber = parseInt(weekLabel.split(" ")[1], 10);
          const { startDate, endDate } = getWeekRange(
            now.getFullYear(),
            now.getMonth(),
            weekNumber
          );
          missions.forEach((mission) => {
            const requirementHtml = renderMissionRequirements(
              mission.requirements || [],
              startDate,
              endDate
            );
            const completed = requirementHtml.completed;
            const missionEl = document.createElement("div");
            missionEl.className = `p-3 rounded-md border ${
              completed ? "border-green-300 bg-green-50" : "border-gray-200"
            }`;
            missionEl.innerHTML = `
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="font-semibold text-gray-800">${mission.title}</div>
                  ${requirementHtml.html}
                </div>
                <div class="flex items-center gap-2">
                  ${
                    completed
                      ? '<span class="text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full">Complete</span>'
                      : ""
                  }
                  <button class="admin-only delete-mission text-red-500 hover:text-red-700" data-scope="weekly" data-id="${mission.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H3.5A1.5 1.5 0 002 5.5V6h16v-.5A1.5 1.5 0 0016.5 4H15V3a1 1 0 00-1-1H6zm3 6a1 1 0 012 0v6a1 1 0 11-2 0V8zm-4 0a1 1 0 112 0v6a1 1 0 11-2 0V8zm8 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg>
                  </button>
                </div>
              </div>
            `;
            list.appendChild(missionEl);
          });
        });

        if (!weeklyContainer.children.length) {
          weeklyContainer.innerHTML =
            '<p class="text-sm text-gray-500">No weekly missions yet.</p>';
        }
      }

      function renderMonthlyChores() {
        monthlyContainer.innerHTML = "";
        const now = new Date();
        const currentMonth = getMonthName(now);
        const months = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        months.forEach((monthLabel, idx) => {
          const missions = monthlyChores.filter(
            (mission) => mission.month === monthLabel
          );
          if (!missions.length) return;
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-lg shadow-md";
          card.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-2">${monthLabel}${
              monthLabel === currentMonth ? " (Current Month)" : ""
            }</h3>
            <div class="space-y-3 missions-list" data-month="${monthLabel}"></div>
          `;
          monthlyContainer.appendChild(card);
          const list = card.querySelector(".missions-list");
          const { startDate, endDate } = getMonthRange(now.getFullYear(), idx);
          missions.forEach((mission) => {
            const requirementHtml = renderMissionRequirements(
              mission.requirements || [],
              startDate,
              endDate
            );
            const completed = requirementHtml.completed;
            const missionEl = document.createElement("div");
            missionEl.className = `p-3 rounded-md border ${
              completed ? "border-green-300 bg-green-50" : "border-gray-200"
            }`;
            missionEl.innerHTML = `
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="font-semibold text-gray-800">${mission.title}</div>
                  ${requirementHtml.html}
                </div>
                <div class="flex items-center gap-2">
                  ${
                    completed
                      ? '<span class="text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full">Complete</span>'
                      : ""
                  }
                  <button class="admin-only delete-mission text-red-500 hover:text-red-700" data-scope="monthly" data-id="${mission.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H3.5A1.5 1.5 0 002 5.5V6h16v-.5A1.5 1.5 0 0016.5 4H15V3a1 1 0 00-1-1H6zm3 6a1 1 0 012 0v6a1 1 0 11-2 0V8zm-4 0a1 1 0 112 0v6a1 1 0 11-2 0V8zm8 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg>
                  </button>
                </div>
              </div>
            `;
            list.appendChild(missionEl);
          });
        });

        if (!monthlyContainer.children.length) {
          monthlyContainer.innerHTML =
            '<p class="text-sm text-gray-500">No monthly missions yet.</p>';
        }
      }

      function renderRewards() {
        rewardsContainer.innerHTML = "";

        if (!settings.pointsEnabled) {
          rewardsContainer.innerHTML = `
                    <div class="col-span-1 md:col-span-2 p-6 bg-gray-50 rounded-lg text-center">
                        <p class="text-gray-600">Allowance stars are currently disabled.</p>
                        <p class="text-gray-600 mt-2">Enable stars in Allowance Settings to use rewards.</p>
                    </div>
                `;
          return;
        }

        rewards.forEach((reward) => {
          const rewardEl = document.createElement("div");
          rewardEl.className = "task-card p-4 bg-white rounded-lg shadow-sm";

          const canAfford = userPoints >= reward.points;

          rewardEl.innerHTML = `
                    <div class="flex items-center mb-3">
                        <span class="text-3xl mr-3">${reward.icon}</span>
                        <div>
                            <h3 class="font-semibold text-gray-800">${
                              reward.name
                            }</h3>
                            <p class="text-purple-600 text-sm font-bold">${
                              reward.points
                            } stars</p>
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <button class="redeem-reward px-3 py-2 rounded-md ${
                          canAfford
                            ? "bg-purple-600 text-white hover:bg-purple-700"
                            : "bg-gray-200 text-gray-500 cursor-not-allowed"
                        }" ${canAfford ? "" : "disabled"}>
                            ${canAfford ? "Redeem Reward" : "Not Enough Stars"}
                        </button>
                        <button class="delete-reward text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;

          rewardsContainer.appendChild(rewardEl);

          // Add event listeners
          const redeemBtn = rewardEl.querySelector(".redeem-reward");
          if (canAfford) {
            redeemBtn.addEventListener("click", () => {
              userPoints -= reward.points;
              updatePointsDisplay();
              renderRewards();
              showCelebration(
                `You redeemed "${reward.name}"! Enjoy your reward!`
              );
            });
          }

          const deleteBtn = rewardEl.querySelector(".delete-reward");
          deleteBtn.addEventListener("click", () => {
            rewards = rewards.filter((r) => r.id !== reward.id);
            renderRewards();
          });
        });
      }

      function renderEditSchedule() {
        const editContainer = document.getElementById(
          "edit-schedule-container"
        );
        editContainer.innerHTML = "";

        // Sort schedule by time
        const sortedSchedule = [...scheduleItems].sort((a, b) =>
          a.time.localeCompare(b.time)
        );

        sortedSchedule.forEach((item) => {
          const itemEl = document.createElement("div");
          itemEl.className = "space-y-2";
          itemEl.dataset.itemId = item.id;

          const isAnytime = !item.time;
          let endTimeInput = "";
          if (item.endTime) {
            endTimeInput = `
                        <div class="flex items-center">
                            <label class="w-24 text-sm text-gray-600">End Time:</label>
                            <input type="time" value="${
                              item.endTime
                            }" class="end-time border border-gray-300 rounded-md px-2 py-1 flex-grow" ${
              isAnytime ? "disabled" : ""
            }>
                        </div>
                    `;
          }
          const anytimeCheckbox = `
                    <div class="flex items-center mt-1">
                        <input type="checkbox" class="anytime-input mr-2" ${
                          isAnytime ? "checked" : ""
                        }>
                        <label class="text-sm text-gray-600">Anytime task (no start time)</label>
                    </div>
                `;

          let mealCheckbox = "";
          if (item.hasMealInput) {
            mealCheckbox = `
                        <div class="flex items-center mt-1">
                            <input type="checkbox" class="meal-input mr-2" checked>
                            <label class="text-sm text-gray-600">Has meal input</label>
                        </div>
                    `;
          } else {
            mealCheckbox = `
                        <div class="flex items-center mt-1">
                            <input type="checkbox" class="meal-input mr-2">
                            <label class="text-sm text-gray-600">Has meal input</label>
                        </div>
                    `;
          }

          const photoCheckbox = `
                    <div class="flex items-center mt-1">
                        <input type="checkbox" class="photo-input mr-2" ${
                          item.requiresPhoto ? "checked" : ""
                        }>
                        <label class="text-sm text-gray-600">Requires photo proof</label>
                    </div>
                `;

          const basicCheckbox = `
                    <div class="flex items-center mt-1">
                        <input type="checkbox" class="basic-input mr-2" ${
                          item.isBasic ? "checked" : ""
                        }>
                        <label class="text-sm text-gray-600">Basic requirement (unlocks paid tasks)</label>
                    </div>
                `;

          const recurringDays = Array.isArray(item.recurringDays)
            ? item.recurringDays
            : [];
          const recurringCheckboxes = [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
            "Sunday",
          ]
            .map(
              (day) => `
                        <label class="flex items-center gap-2 text-xs text-gray-600">
                            <input type="checkbox" class="recurring-day" value="${day}" ${
                recurringDays.includes(day) ? "checked" : ""
              }>
                            ${day.slice(0, 3)}
                        </label>
                    `
            )
            .join("");
          const recurringInput = `
                    <div class="flex flex-wrap items-center gap-2 mt-1">
                        <span class="text-sm text-gray-600">Repeat on:</span>
                        ${recurringCheckboxes}
                        <span class="text-xs text-gray-400">(leave blank for daily)</span>
                    </div>
                `;

          let pointsInput = "";
          if (settings.pointsEnabled) {
            pointsInput = `
                        <div class="flex items-center">
                            <label class="w-24 text-sm text-gray-600">Stars:</label>
                            <input type="number" value="${item.points}" min="0" class="points-value border border-gray-300 rounded-md px-2 py-1 w-20">
                        </div>
                    `;
          }

          itemEl.innerHTML = `
                    <div class="flex items-center">
                        <label class="w-24 text-sm text-gray-600">Start Time:</label>
                        <input type="time" value="${
                          item.time || ""
                        }" class="start-time border border-gray-300 rounded-md px-2 py-1 flex-grow" ${
            isAnytime ? "disabled" : ""
          }>
                    </div>
                    ${endTimeInput}
                    ${anytimeCheckbox}
                    <div class="flex items-center">
                        <label class="w-24 text-sm text-gray-600">Task:</label>
                        <input type="text" value="${
                          item.task
                        }" class="task-name border border-gray-300 rounded-md px-2 py-1 flex-grow">
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 text-sm text-gray-600">Type:</label>
                        <select class="task-type border border-gray-300 rounded-md px-2 py-1 flex-grow">
                            <option value="focus" ${
                              item.type === "focus" ? "selected" : ""
                            }>Focus Block</option>
                            <option value="break" ${
                              item.type === "break" ? "selected" : ""
                            }>Break</option>
                            <option value="chore" ${
                              item.type === "chore" ? "selected" : ""
                            }>Mission</option>
                            <option value="personal" ${
                              item.type === "personal" ? "selected" : ""
                            }>Personal</option>
                        </select>
                    </div>
                    ${pointsInput}
                    ${mealCheckbox}
                    ${photoCheckbox}
                    ${basicCheckbox}
                    ${recurringInput}
                    <button class="delete-schedule-item text-red-500 hover:text-red-700 text-sm">
                        Remove this item
                    </button>
                    <hr class="my-3">
                `;

          editContainer.appendChild(itemEl);
          syncScheduleFromEditor();

          // Add event listener to delete button
          const deleteBtn = itemEl.querySelector(".delete-schedule-item");
          const anytimeInput = itemEl.querySelector(".anytime-input");
          const startTimeInput = itemEl.querySelector(".start-time");
          const endTimeInputEl = itemEl.querySelector(".end-time");
          deleteBtn.addEventListener("click", () => {
            itemEl.remove();
            syncScheduleFromEditor();
          });
          if (anytimeInput) {
            anytimeInput.addEventListener("change", () => {
              const isChecked = anytimeInput.checked;
              if (startTimeInput) {
                startTimeInput.disabled = isChecked;
                if (isChecked) {
                  startTimeInput.value = "";
                }
              }
              if (endTimeInputEl) {
                endTimeInputEl.disabled = isChecked;
                if (isChecked) {
                  endTimeInputEl.value = "";
                }
              }
              syncScheduleFromEditor();
            });
          }
        });

        editContainer.oninput = () => {
          syncScheduleFromEditor();
        };
        editContainer.onchange = () => {
          syncScheduleFromEditor();
        };
      }

      function syncScheduleFromEditor() {
        const editContainer = document.getElementById(
          "edit-schedule-container"
        );
        const items = editContainer.querySelectorAll("div.space-y-2");
        const existingById = new Map(
          scheduleItems.map((item) => [String(item.id), item])
        );
        let maxId = scheduleItems.reduce(
          (max, item) => Math.max(max, item.id || 0),
          0
        );

        const newSchedule = [];
        items.forEach((itemEl) => {
          const startTimeInput = itemEl.querySelector(".start-time");
          const endTimeInput = itemEl.querySelector(".end-time");
          const taskInput = itemEl.querySelector(".task-name");
          const typeSelect = itemEl.querySelector(".task-type");
          const mealInput = itemEl.querySelector(".meal-input");
          const photoInput = itemEl.querySelector(".photo-input");
          const basicInput = itemEl.querySelector(".basic-input");
          const pointsInput = itemEl.querySelector(".points-value");
          const recurringInputs = itemEl.querySelectorAll(".recurring-day");

          if (taskInput && taskInput.value) {
            let rawId = itemEl.dataset.itemId;
            let id = rawId ? parseInt(rawId, 10) : NaN;
            if (!id || Number.isNaN(id)) {
              id = ++maxId;
              itemEl.dataset.itemId = id;
            }
            const previous = existingById.get(String(id));

            const newItem = {
              id,
              time:
                startTimeInput && startTimeInput.value
                  ? startTimeInput.value
                  : "",
              task: taskInput.value,
              completed: previous ? previous.completed : false,
              type: typeSelect ? typeSelect.value : "personal",
              points:
                settings.pointsEnabled && pointsInput
                  ? parseInt(pointsInput.value)
                  : settings.defaultPoints.dailyTask,
              requiresPhoto: photoInput ? photoInput.checked : false,
              isBasic: basicInput ? basicInput.checked : false,
              recurringDays: Array.from(recurringInputs)
                .filter((input) => input.checked)
                .map((input) => input.value),
            };

            if (endTimeInput && endTimeInput.value) {
              newItem.endTime = endTimeInput.value;
            }

            if (mealInput && mealInput.checked) {
              newItem.hasMealInput = true;
            }

            if (previous) {
              newItem.actualActivity = previous.actualActivity || "";
              newItem.pendingApproval = !!previous.pendingApproval;
              newItem.pendingRelease = !!previous.pendingRelease;
              newItem.proofImage = previous.proofImage || "";
              newItem.autoReviewStatus = previous.autoReviewStatus || "";
            }

            newSchedule.push(newItem);
          }
        });

        scheduleItems = newSchedule;
        renderSchedule();
        updateProgress();
        saveCompletedTasks();
      }

      function renderPointSettings() {
        document.getElementById("points-toggle").checked =
          settings.pointsEnabled;
        document.getElementById("daily-task-points").value =
          settings.defaultPoints.dailyTask;
        document.getElementById("weekly-chore-points").value =
          settings.defaultPoints.weeklyChore;
        document.getElementById("monthly-chore-points").value =
          settings.defaultPoints.monthlyChore;

        // Show/hide point values container based on toggle
        const pointValuesContainer = document.getElementById(
          "point-values-container"
        );
        if (settings.pointsEnabled) {
          pointValuesContainer.classList.remove("hidden");
        } else {
          pointValuesContainer.classList.add("hidden");
        }

        // Add event listener to toggle
        document
          .getElementById("points-toggle")
          .addEventListener("change", function () {
            if (this.checked) {
              pointValuesContainer.classList.remove("hidden");
            } else {
              pointValuesContainer.classList.add("hidden");
            }
          });
      }

      function showCelebration(message) {
        celebrationMessage.textContent = message;
        celebrationModal.classList.remove("hidden");

        // Create confetti effect
        createConfetti();
      }

      function createConfetti() {
        const confettiContainer = document.body;
        const colors = [
          "#ff0000",
          "#00ff00",
          "#0000ff",
          "#ffff00",
          "#ff00ff",
          "#00ffff",
        ];

        for (let i = 0; i < 50; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.left = `${Math.random() * 100}%`;
          confetti.style.top = `${Math.random() * 100}%`;
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.opacity = "1";
          confettiContainer.appendChild(confetti);

          // Animate confetti
          const animationDuration = 1000 + Math.random() * 2000;
          confetti.animate(
            [
              { transform: "translateY(0) rotate(0)", opacity: 1 },
              {
                transform: `translateY(${100 + Math.random() * 200}px) rotate(${
                  360 * Math.random()
                }deg)`,
                opacity: 0,
              },
            ],
            {
              duration: animationDuration,
              easing: "cubic-bezier(0.1, 0.8, 0.3, 1)",
            }
          );

          // Remove confetti after animation
          setTimeout(() => {
            confetti.remove();
          }, animationDuration);
        }
      }

      // Event listeners
      document
        .getElementById("refactor-schedule")
        .addEventListener("click", () => {
          scheduleRefactorActive = true;
          renderSchedule();
          updateProgress();
          showCelebration("Schedule refactored for the current time!");
        });

      document.getElementById("edit-schedule").addEventListener("click", () => {
        if (!isAdmin) {
          showCelebration("Admin sign-in required to edit the schedule.");
          return;
        }
        renderEditSchedule();
        editModal.classList.remove("hidden");
      });

      document.getElementById("close-modal").addEventListener("click", () => {
        editModal.classList.add("hidden");
      });

      document
        .getElementById("add-schedule-item")
        .addEventListener("click", () => {
          const editContainer = document.getElementById(
            "edit-schedule-container"
          );
          const itemEl = document.createElement("div");
          itemEl.className = "space-y-2";

          let pointsInput = "";
          if (settings.pointsEnabled) {
            pointsInput = `
                    <div class="flex items-center">
                        <label class="w-24 text-sm text-gray-600">Stars:</label>
                        <input type="number" value="${settings.defaultPoints.dailyTask}" min="0" class="points-value border border-gray-300 rounded-md px-2 py-1 w-20">
                    </div>
                `;
          }

          itemEl.innerHTML = `
                <div class="flex items-center">
                    <label class="w-24 text-sm text-gray-600">Start Time:</label>
                    <input type="time" value="12:00" class="start-time border border-gray-300 rounded-md px-2 py-1 flex-grow">
                </div>
                <div class="flex items-center">
                    <label class="w-24 text-sm text-gray-600">End Time:</label>
                    <input type="time" value="12:30" class="end-time border border-gray-300 rounded-md px-2 py-1 flex-grow">
                </div>
                <div class="flex items-center mt-1">
                    <input type="checkbox" class="anytime-input mr-2">
                    <label class="text-sm text-gray-600">Anytime task (no start time)</label>
                </div>
                <div class="flex items-center">
                    <label class="w-24 text-sm text-gray-600">Task:</label>
                    <input type="text" value="New task" class="task-name border border-gray-300 rounded-md px-2 py-1 flex-grow">
                </div>
                <div class="flex items-center">
                    <label class="w-24 text-sm text-gray-600">Type:</label>
                    <select class="task-type border border-gray-300 rounded-md px-2 py-1 flex-grow">
                        <option value="focus">Focus Block</option>
                        <option value="break">Break</option>
                        <option value="chore">Mission</option>
                        <option value="personal" selected>Personal</option>
                    </select>
                </div>
                ${pointsInput}
                <div class="flex items-center mt-1">
                    <input type="checkbox" class="meal-input mr-2">
                    <label class="text-sm text-gray-600">Has meal input</label>
                </div>
                <div class="flex items-center mt-1">
                    <input type="checkbox" class="photo-input mr-2">
                    <label class="text-sm text-gray-600">Requires photo proof</label>
                </div>
                <div class="flex items-center mt-1">
                    <input type="checkbox" class="basic-input mr-2">
                    <label class="text-sm text-gray-600">Basic requirement (unlocks paid tasks)</label>
                </div>
                <div class="flex flex-wrap items-center gap-2 mt-1">
                    <span class="text-sm text-gray-600">Repeat on:</span>
                    ${[
                      "Monday",
                      "Tuesday",
                      "Wednesday",
                      "Thursday",
                      "Friday",
                      "Saturday",
                      "Sunday",
                    ]
                      .map(
                        (day) => `
                        <label class="flex items-center gap-2 text-xs text-gray-600">
                            <input type="checkbox" class="recurring-day" value="${day}">
                            ${day.slice(0, 3)}
                        </label>
                    `
                      )
                      .join("")}
                    <span class="text-xs text-gray-400">(leave blank for daily)</span>
                </div>
                <button class="delete-schedule-item text-red-500 hover:text-red-700 text-sm">
                    Remove this item
                </button>
                <hr class="my-3">
            `;

          editContainer.appendChild(itemEl);

          // Add event listener to delete button
          const deleteBtn = itemEl.querySelector(".delete-schedule-item");
          const anytimeInput = itemEl.querySelector(".anytime-input");
          const startTimeInput = itemEl.querySelector(".start-time");
          const endTimeInputEl = itemEl.querySelector(".end-time");
          deleteBtn.addEventListener("click", () => {
            itemEl.remove();
          });
          anytimeInput.addEventListener("change", () => {
            const isChecked = anytimeInput.checked;
            startTimeInput.disabled = isChecked;
            endTimeInputEl.disabled = isChecked;
            if (isChecked) {
              startTimeInput.value = "";
              endTimeInputEl.value = "";
            }
          });
        });

      document.getElementById("save-schedule").addEventListener("click", () => {
        syncScheduleFromEditor();
        editModal.classList.add("hidden");
      });

      document
        .getElementById("add-weekly-chore")
        .addEventListener("click", () => {
          document.getElementById("chore-modal-title").textContent =
            "Add Weekly Mission";
          document.getElementById("chore-name").value = "";
          document
            .getElementById("chore-day-container")
            .classList.add("hidden");
          document
            .getElementById("chore-week-container")
            .classList.remove("hidden");
          document
            .getElementById("chore-month-container")
            .classList.add("hidden");
          document.getElementById("save-chore").dataset.type = "weekly";

          document
            .getElementById("chore-points-container")
            .classList.add("hidden");

          choreModal.classList.remove("hidden");
        });

      document
        .getElementById("add-daily-bonus")
        .addEventListener("click", () => {
          document.getElementById("chore-modal-title").textContent =
            "Add Daily Bonus Mission";
          document.getElementById("chore-name").value = "";
          document
            .getElementById("chore-day-container")
            .classList.remove("hidden");
          document
            .getElementById("chore-week-container")
            .classList.add("hidden");
          document
            .getElementById("chore-month-container")
            .classList.add("hidden");
          document.getElementById("save-chore").dataset.type = "daily";
          document
            .getElementById("chore-points-container")
            .classList.add("hidden");
          choreModal.classList.remove("hidden");
        });

      document
        .getElementById("add-monthly-chore")
        .addEventListener("click", () => {
          document.getElementById("chore-modal-title").textContent =
            "Add Monthly Mission";
          document.getElementById("chore-name").value = "";
          document
            .getElementById("chore-day-container")
            .classList.add("hidden");
          document
            .getElementById("chore-week-container")
            .classList.add("hidden");
          document
            .getElementById("chore-month-container")
            .classList.remove("hidden");
          document.getElementById("save-chore").dataset.type = "monthly";

          document
            .getElementById("chore-points-container")
            .classList.add("hidden");

          choreModal.classList.remove("hidden");
        });

      document
        .getElementById("close-chore-modal")
        .addEventListener("click", () => {
          choreModal.classList.add("hidden");
        });

      document.getElementById("save-chore").addEventListener("click", () => {
        const name = document.getElementById("chore-name").value.trim();
        const type = document.getElementById("save-chore").dataset.type;
        const req1Type = document.getElementById("mission-req-1-type").value;
        const req1Target = parseInt(
          document.getElementById("mission-req-1-target").value,
          10
        );
        const req2Type = document.getElementById("mission-req-2-type").value;
        const req2Target = parseInt(
          document.getElementById("mission-req-2-target").value,
          10
        );
        const requirements = [];
        if (req1Type && req1Target > 0) {
          requirements.push({ type: req1Type, target: req1Target });
        }
        if (req2Type && req2Target > 0) {
          requirements.push({ type: req2Type, target: req2Target });
        }

        if (name) {
          if (type === "daily") {
            const day = document.getElementById("chore-day").value;
            const newId =
              dailyBonusMissions.length > 0
                ? Math.max(...dailyBonusMissions.map((c) => c.id)) + 1
                : 1;

            dailyBonusMissions.push({
              id: newId,
              dayOfWeek: day,
              title: name,
              requirements,
            });

            renderDailyBonusMissions();
          } else if (type === "weekly") {
            const week = document.getElementById("chore-week").value;
            const newId =
              weeklyChores.length > 0
                ? Math.max(...weeklyChores.map((c) => c.id)) + 1
                : 1;

            weeklyChores.push({
              id: newId,
              weekOfMonth: week,
              title: name,
              requirements,
            });

            renderWeeklyChores();
          } else if (type === "monthly") {
            const month = document.getElementById("chore-month").value;
            const newId =
              monthlyChores.length > 0
                ? Math.max(...monthlyChores.map((c) => c.id)) + 1
                : 1;

            monthlyChores.push({
              id: newId,
              month,
              title: name,
              requirements,
            });

            renderMonthlyChores();
          }

          saveMissionsToStorage();
          choreModal.classList.add("hidden");
        }
      });

      document.getElementById("add-reward").addEventListener("click", () => {
        document.getElementById("reward-name").value = "";
        document.getElementById("reward-points").value = "20";
        document.getElementById("reward-icon").value = "üéÅ";
        rewardModal.classList.remove("hidden");
      });

      document
        .getElementById("close-reward-modal")
        .addEventListener("click", () => {
          rewardModal.classList.add("hidden");
        });

      document.getElementById("save-reward").addEventListener("click", () => {
        const name = document.getElementById("reward-name").value.trim();
        const points = parseInt(document.getElementById("reward-points").value);
        const icon =
          document.getElementById("reward-icon").value.trim() || "üéÅ";

        if (name && points > 0) {
          const newId =
            rewards.length > 0 ? Math.max(...rewards.map((r) => r.id)) + 1 : 1;

          rewards.push({
            id: newId,
            name: name,
            points: points,
            icon: icon,
          });

          renderRewards();
          rewardModal.classList.add("hidden");
        }
      });

      document
        .getElementById("point-settings")
        .addEventListener("click", () => {
          renderPointSettings();
          pointsModal.classList.remove("hidden");
        });

      document
        .getElementById("close-points-modal")
        .addEventListener("click", () => {
          pointsModal.classList.add("hidden");
        });

      document
        .getElementById("save-points-settings")
        .addEventListener("click", () => {
          settings.pointsEnabled =
            document.getElementById("points-toggle").checked;

          if (settings.pointsEnabled) {
            settings.defaultPoints.dailyTask =
              parseInt(document.getElementById("daily-task-points").value) || 5;
            settings.defaultPoints.weeklyChore =
              parseInt(document.getElementById("weekly-chore-points").value) ||
              10;
            settings.defaultPoints.monthlyChore =
              parseInt(document.getElementById("monthly-chore-points").value) ||
              20;
          }

          updatePointsDisplay();
          renderSchedule();
          renderWeeklyChores();
          renderMonthlyChores();
          renderRewards();

          pointsModal.classList.add("hidden");

          showCelebration("Allowance settings updated!");
        });

      document.getElementById("reset-points").addEventListener("click", () => {
        if (confirm("Are you sure you want to reset all stars to zero?")) {
          userPoints = 0;
          updatePointsDisplay();
          showCelebration("Stars have been reset to zero.");
        }
      });

      document
        .getElementById("close-meal-modal")
        .addEventListener("click", () => {
          mealModal.classList.add("hidden");
        });

      document.getElementById("save-meal").addEventListener("click", () => {
        const mealNotesInput = document
          .getElementById("meal-notes")
          .value.trim();
        mealNotes = mealNotesInput;

        const itemId = parseInt(mealModal.dataset.itemId);
        const item = scheduleItems.find((i) => i.id === itemId);

        if (item) {
          if (item.requiresPhoto) {
            mealModal.classList.add("hidden");
            openProofModal({ type: "schedule", item });
            return;
          }
          item.completed = true;
          if (settings.pointsEnabled) {
            const itemPoints = getEffectivePoints(item);
            if (itemPoints > 0) {
              if (areBasicsComplete()) {
                userPoints += itemPoints;
                updatePointsDisplay();
                showCelebration(
                  `You completed "${item.task}"! +${itemPoints} stars`
                );
              } else {
                item.pendingRelease = true;
                pendingPoints += itemPoints;
                updatePointsDisplay();
                showCelebration(
                  `You completed "${item.task}"! Stars are pending until basics are done.`
                );
              }
            } else {
              showCelebration(`You completed "${item.task}"!`);
            }
          } else {
            showCelebration(`You completed "${item.task}"!`);
          }
          renderSchedule();
          updateProgress();
          releasePendingRewards();
          saveCompletedTasks();
        }

        mealModal.classList.add("hidden");
      });

      document
        .getElementById("close-proof-modal")
        .addEventListener("click", () => {
          proofModal.classList.add("hidden");
        });

      document.getElementById("cancel-proof").addEventListener("click", () => {
        proofModal.classList.add("hidden");
      });

      proofFileInput.addEventListener("change", () => {
        const file = proofFileInput.files[0];
        if (!file) {
          proofPreviewWrapper.classList.add("hidden");
          proofPreview.src = "";
          document.getElementById("submit-proof").disabled = true;
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          proofPreview.src = reader.result;
          proofPreviewWrapper.classList.remove("hidden");
          document.getElementById("submit-proof").disabled = false;
        };
        reader.readAsDataURL(file);
      });

      document
        .getElementById("submit-proof")
        .addEventListener("click", async () => {
          const type = proofModal.dataset.type;
          const itemId = parseInt(proofModal.dataset.itemId);
          const item = getItemByType(type, itemId);

          if (!item || !proofPreview.src) {
            return;
          }

          item.proofImage = proofPreview.src;
          item.proofDate = getTodayString();

          if (item.requiresHomeworkCheck) {
            item.autoReviewStatus = "pending";
            proofModal.classList.add("hidden");
            showCelebration(`Reviewing "${item.task}" screenshot...`);

            const review = await autoReviewHomework(item);
            if (review.approved) {
              item.autoReviewStatus = "approved";
              approveTask(item, item.task);
              showCelebration(
                `"${item.task}" auto-approved from the Acellus tracker!`
              );
            } else {
              item.autoReviewStatus = "denied";
              denyTask(item, item.task);
              showCelebration(
                `"${item.task}" auto-denied. Please upload a clear Acellus tracker screenshot.`
              );
            }
          } else {
            requestApproval(item);
            proofModal.classList.add("hidden");
            showCelebration(
              `Proof uploaded for "${item.task}"! Stars are pending approval.`
            );
          }

          if (type === "schedule") {
            renderSchedule();
            updateProgress();
          } else if (type === "weekly") {
            renderWeeklyChores();
          } else if (type === "monthly") {
            renderMonthlyChores();
          }
        });

      function updateAdminVisibility() {
        document.querySelectorAll(".admin-only").forEach((element) => {
          element.classList.toggle("hidden", !isAdmin);
        });
        adminToggle.textContent = isAdmin ? "Admin Sign Out" : "Admin Sign In";
      }

      adminToggle.addEventListener("click", () => {
        if (isAdmin) {
          isAdmin = false;
          updateAdminVisibility();
          renderSchedule();
          renderWeeklyChores();
          renderMonthlyChores();
          showCelebration("Admin mode disabled.");
          return;
        }
        adminPasscodeInput.value = "";
        adminError.classList.add("hidden");
        adminModal.classList.remove("hidden");
      });

      document
        .getElementById("close-admin-modal")
        .addEventListener("click", () => {
          adminModal.classList.add("hidden");
        });

      document.getElementById("admin-cancel").addEventListener("click", () => {
        adminModal.classList.add("hidden");
      });
      document.getElementById("admin-login").addEventListener("click", () => {
        if (adminPasscodeInput.value === adminPasscode) {
          isAdmin = true;
          adminModal.classList.add("hidden");
          updateAdminVisibility();
          renderSchedule();
          renderWeeklyChores();
          renderMonthlyChores();
          showCelebration("Admin mode enabled.");
        } else {
          adminError.classList.remove("hidden");
        }
      });

      document
        .getElementById("close-celebration")
        .addEventListener("click", () => {
          celebrationModal.classList.add("hidden");
        });

      document.getElementById("save-notes").addEventListener("click", () => {
        dailyNotes = document.getElementById("daily-notes").value;
        showCelebration("Notes saved successfully!");
        saveDailyNotes();
      });

      if (moodButtons && moodButtons.length > 0) {
        moodButtons.forEach((button) => {
          button.addEventListener("click", () => {
            selectedMood = button.getAttribute("data-mood");
            updateMoodButtons();
          });
        });
      }

      const saveMoodButton = document.getElementById("save-mood");
      if (saveMoodButton) {
        saveMoodButton.addEventListener("click", () => {
          saveMoodCheckin();
        });
      }

      const saveJournalButton = document.getElementById("save-journal");
      if (saveJournalButton) {
        saveJournalButton.addEventListener("click", () => {
          saveJournal();
        });
      }

      if (habitItemAdd) {
        habitItemAdd.addEventListener("click", () => {
          addHabitFromInputs();
        });
      }
      if (habitSaveButton) {
        habitSaveButton.addEventListener("click", () => {
          handleHabitSave();
        });
      }

      const openAvatarBuilderButton = document.getElementById(
        "open-avatar-builder"
      );
      if (openAvatarBuilderButton) {
        openAvatarBuilderButton.addEventListener("click", () => {
          openAvatarBuilder();
        });
      }

      bootstrapApp().catch((error) => {
        console.warn("Failed to initialize app", error);
      });

      // Update time every second
      setInterval(updateDateTime, 1000);
    </script>
    <script src="/planner-schedule.js" defer></script>
  </body>
</html>
